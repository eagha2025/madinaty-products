<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุฅุฏุงุฑุฉ ููุชุฌุงุช ูุฏููุชู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
        .nav-item.active { background-color: #dcfce7; color: #166534; border-right: 4px solid #166534; }
        .glass { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        [x-cloak] { display: none !important; }
        
        /* ุญุงูุฉ ุฌุฏูุฏ: ูููุถ ุฃุญูุฑ ุบุงูู */
        .status-new { background-color: #fee2e2; color: #7f1d1d; border: 1px solid #f87171; animation: pulse-red 1.5s infinite; font-weight: 800; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        
        /* ุชูุณูู ุงูุทุจุงุนุฉ */
        @media print { body * { visibility: hidden; } #printable-area, #printable-area * { visibility: visible; } #printable-area { position: absolute; left: 0; top: 0; width: 80mm; } }
    </style>
</head>
<body class="text-slate-800" x-data="adminPanel()">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-white border-l flex-shrink-0 hidden md:flex flex-col z-20 shadow-xl">
            <div class="p-6 border-b flex flex-col items-center justify-center text-center bg-green-50">
                <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white font-bold text-xl mb-2">ู</div>
                <h1 class="font-extrabold text-lg text-green-900">ููุญุฉ ุงูุฅุฏุงุฑุฉ</h1>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="switchTab('dashboard')" :class="currentTab==='dashboard'?'active':''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition"><span class="text-lg">๐</span> <span class="font-bold">ููุญุฉ ุงูุนุฑุถ</span></button>
                <button @click="switchTab('orders')" :class="currentTab==='orders'?'active':''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition"><span class="text-lg">๐ฆ</span> <span class="font-bold">ุณุฌู ุงูุทูุจุงุช</span></button>
                <button @click="switchTab('products')" :class="currentTab==='products'?'active':''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition"><span class="text-lg">๐ท๏ธ</span> <span class="font-bold">ุงูููุชุฌุงุช</span></button>
                <button @click="switchTab('reports')" :class="currentTab==='reports'?'active':''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition"><span class="text-lg">๐</span> <span class="font-bold">ุงูุชูุงุฑูุฑ</span></button>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-6 relative bg-slate-50">
            <div class="flex justify-between items-center mb-8">
                <div><h2 class="text-2xl font-extrabold text-slate-800" x-text="pageTitle"></h2><p class="text-xs text-gray-500 mt-1 font-bold text-green-600" x-text="currentTimeDate"></p></div>
                <div class="flex items-center gap-4">
                    <div class="relative cursor-pointer p-2 bg-white rounded-full shadow-sm hover:bg-gray-100 transition" @click="currentTab='orders'">
                        <span class="text-2xl">๐</span>
                        <span x-show="newOrdersCount > 0" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-white animate-bounce" x-text="newOrdersCount"></span>
                    </div>
                    <button @click="fetchData()" class="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-xl text-sm font-bold shadow-sm flex items-center gap-2"><span x-show="loading" class="animate-spin">โป</span> ุชุญุฏูุซ</button>
                </div>
            </div>

            <div x-show="currentTab==='dashboard'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5 mb-8">
                    <div class="glass p-5 border-b-4 border-green-500"><p class="text-xs font-bold text-gray-500">ุฅุฌูุงูู ุงููุจูุนุงุช</p><p class="text-2xl font-extrabold mt-1" x-text="formatMoney(stats.totalRevenue)"></p></div>
                    <div class="glass p-5 border-b-4 border-blue-500"><p class="text-xs font-bold text-gray-500">ุนุฏุฏ ุงูุทูุจุงุช</p><p class="text-2xl font-extrabold mt-1" x-text="stats.totalOrders"></p></div>
                    <div class="glass p-5 border-b-4 border-yellow-500"><p class="text-xs font-bold text-gray-500">ุทูุจุงุช ุฌุฏูุฏุฉ</p><p class="text-2xl font-extrabold mt-1 text-red-600 animate-pulse" x-text="newOrdersCount"></p></div>
                    <div class="glass p-5 border-b-4 border-purple-500"><p class="text-xs font-bold text-gray-500">ูุจูุนุงุช ุงูููู</p><p class="text-2xl font-extrabold mt-1" x-text="formatMoney(reportStats.today)"></p></div>
                </div>
                <div class="glass p-6"><h3 class="font-bold mb-4 text-gray-700">๐ ุงูุฃูุซุฑ ูุจูุนุงู</h3><table class="w-full text-sm text-right"><thead class="bg-orange-50 text-orange-800"><tr><th class="p-2">ุงูููุชุฌ</th><th class="p-2">ุงูุนุฏุฏ</th></tr></thead><tbody><template x-for="(i,x) in getBestSellers().slice(0,5)" :key="x"><tr class="border-b"><td class="p-2" x-text="i.name"></td><td class="p-2 font-bold" x-text="i.count"></td></tr></template></tbody></table></div>
            </div>

            <div x-show="currentTab==='orders'" x-transition>
                <div class="glass p-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-6 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex-1"><label class="text-xs font-bold text-gray-500 block mb-1">ุจุญุซ ุณุฑูุน</label><input x-model="searchQuery" @input="filterList()" type="text" placeholder="ุงุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุงูุฑูู..." class="w-full border p-2 rounded-lg text-sm bg-gray-50 focus:bg-white transition"></div>
                        <div><label class="text-xs font-bold text-gray-500 block mb-1">ุงููุชุฑุฉ</label><select x-model="dateFilter" @change="filterList()" class="border p-2 rounded-lg text-sm w-40 bg-gray-50"><option value="all">ุงููู</option><option value="today">ุงูููู</option><option value="week">ูุฐุง ุงูุฃุณุจูุน</option><option value="month">ูุฐุง ุงูุดูุฑ</option><option value="custom">ูุฎุตุต</option></select></div>
                        <div x-show="dateFilter==='custom'" class="flex gap-2"><div><label class="text-[10px]">ูู</label><input type="date" x-model="customStartDate" @change="filterList()" class="border p-1.5 rounded-lg text-sm"></div><div><label class="text-[10px]">ุฅูู</label><input type="date" x-model="customEndDate" @change="filterList()" class="border p-1.5 rounded-lg text-sm"></div></div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-gray-200">
                        <table class="w-full text-sm text-right bg-white">
                            <thead class="bg-gray-100 text-gray-700 font-bold sticky top-0"><tr><th class="p-3">#</th><th class="p-3">ุงูุชุงุฑูุฎ</th><th class="p-3">ุงูุนููู</th><th class="p-3">ุงููุงุชู</th><th class="p-3 text-center">ุงูุญุงูุฉ</th><th class="p-3">ุงูููุงุญุธุงุช</th><th class="p-3">ุงูุฅุฌูุงูู</th><th class="p-3"></th></tr></thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="o in filteredOrders" :key="o.Order_ID">
                                    <tr class="hover:bg-blue-50 transition cursor-pointer group" @click="openModal(o)">
                                        <td class="font-mono p-3 text-gray-500" x-text="'#'+o.Order_ID"></td>
                                        <td class="p-3 text-xs text-gray-500"><div x-text="o.Date.split(',')[0]"></div><div class="text-[10px]" x-text="o.Date.split(',')[1]"></div></td>
                                        <td class="font-bold p-3 text-gray-800" x-text="o.Customer_Name"></td>
                                        <td class="font-mono p-3 text-gray-600" x-text="o.Phone"></td>
                                        <td class="text-center p-3"><span class="px-3 py-1 rounded-full text-xs font-bold" :class="o.Status==='ุฌุฏูุฏ'?'status-new':getStatusColor(o.Status)" x-text="o.Status"></span></td>
                                        <td class="p-3 text-xs text-gray-500 italic max-w-xs truncate" x-text="o.Note || '-'"></td>
                                        <td class="font-bold text-green-700 p-3" x-text="formatMoney(o.Total_Amount)"></td>
                                        <td class="p-3 text-center"><button class="bg-white border border-gray-300 text-gray-600 px-3 py-1 rounded-lg text-xs font-bold group-hover:bg-blue-600 group-hover:text-white transition">ุนุฑุถ</button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div x-show="currentTab==='products'" x-transition>
                <div class="glass p-6">
                    <div class="flex justify-between mb-6"><h3 class="font-bold text-lg">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h3><button @click="openProductModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold">+ ุฅุถุงูุฉ ููุชุฌ</button></div>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-right bg-white border rounded-lg"><thead class="bg-gray-100 font-bold"><tr><th class="p-3">ุงูุงุณู</th><th class="p-3">ุงููุณู</th><th class="p-3">ุงูุณุนุฑ</th><th class="p-3">ุงูุชูููุฉ</th><th class="p-3">ุงูุญุงูุฉ</th><th class="p-3"></th></tr></thead><tbody class="divide-y"><template x-for="p in products"><tr class="hover:bg-gray-50"><td class="p-3 font-bold" x-text="p.Name"></td><td class="p-3 text-gray-500" x-text="p.Category"></td><td class="p-3 text-green-600" x-text="p.Price"></td><td class="p-3 text-gray-400" x-text="p.Cost"></td><td class="p-3" x-text="p.Available"></td><td class="p-3 flex gap-2"><button @click="openProductModal(p)" class="text-blue-600 bg-blue-100 p-2 rounded">โ๏ธ</button><button @click="deleteProduct(p.ID)" class="text-red-600 bg-red-100 p-2 rounded">๐๏ธ</button></td></tr></template></tbody></table></div>
                </div>
            </div>

            <div x-show="currentTab==='reports'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-6 text-center border-t-4 border-green-600"><h4 class="text-gray-500 font-bold text-sm">ุตุงูู ุงูุฑุจุญ ุงูุชูุฏูุฑู</h4><p class="text-3xl font-extrabold text-green-700 mt-2" x-text="formatMoney(financials.netProfit)"></p></div>
                    <div class="glass p-6 text-center border-t-4 border-blue-600"><h4 class="text-gray-500 font-bold text-sm">ูุชูุณุท ูููุฉ ุงูุทูุจ</h4><p class="text-3xl font-extrabold text-blue-700 mt-2" x-text="formatMoney(financials.aov)"></p></div>
                    <div class="glass p-6 text-center border-t-4 border-red-500"><h4 class="text-gray-500 font-bold text-sm">ุงูููุชุฌุงุช ุงูุฑุงูุฏุฉ</h4><p class="text-3xl font-extrabold text-red-700 mt-2" x-text="financials.deadStock"></p></div>
                </div>
                <div class="glass p-6"><h3 class="font-bold text-gray-700 mb-4">ุชุญููู ุงููุจูุนุงุช (ุฃุณุจูุนู)</h3><div class="h-64 relative"><canvas id="financialChart"></canvas></div></div>
            </div>

        </main>
    </div>

    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm" @click.self="showModal=false">
        <div class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl overflow-hidden flex flex-col md:flex-row h-[500px]">
            
            <div class="w-full md:w-1/2 bg-green-50 p-6 flex flex-col border-l border-green-100">
                <div class="flex justify-between items-start mb-4">
                    <div><p class="text-xs text-green-600 font-bold mb-1">ุชุงุฑูุฎ ุงูุทูุจ</p><p class="text-sm font-bold text-green-900" x-text="selectedOrder.Date"></p></div>
                    <span class="bg-white text-green-800 px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-green-100">๐ ุงููุงุชูุฑุฉ</span>
                </div>
                
                <div class="flex-1 overflow-y-auto pr-1">
                    <table class="w-full text-sm text-right">
                        <thead class="text-green-700 text-xs border-b border-green-200"><tr><th class="pb-2">ุงูุตูู</th><th class="pb-2 text-center">ุงููููุฉ</th><th class="pb-2 text-center">ุงูุณุนุฑ</th><th class="pb-2 text-center">ุงูุฅุฌูุงูู</th></tr></thead>
                        <tbody class="divide-y divide-green-200">
                            <template x-for="item in parseOrderDetails(selectedOrder.Order_Details)">
                                <tr>
                                    <td class="py-3 font-medium text-gray-800" x-text="item.name"></td>
                                    <td class="py-3 text-center text-gray-600" x-text="item.qty"></td>
                                    <td class="py-3 text-center text-gray-600" x-text="item.price"></td>
                                    <td class="py-3 text-center font-bold text-green-700" x-text="item.price > 0 ? formatMoney(item.price * item.qty) : '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 pt-4 border-t border-green-200 flex justify-between items-center">
                    <span class="text-green-900 font-bold text-lg">ุงูุฅุฌูุงูู ุงูููุงุฆู:</span>
                    <span class="text-3xl font-extrabold text-green-700" x-text="formatMoney(selectedOrder.Total_Amount)"></span>
                </div>
            </div>

            <div class="w-full md:w-1/2 p-6 flex flex-col bg-white">
                <div class="flex justify-between mb-6">
                    <h3 class="font-bold text-xl text-gray-800">ุชูุงุตูู ุงูุทูุจ <span class="text-blue-600" x-text="'#'+selectedOrder.Order_ID"></span></h3>
                    <button @click="showModal=false" class="text-gray-400 hover:text-red-500 text-2xl">โ</button>
                </div>

                <div class="bg-blue-50 rounded-xl p-5 border border-blue-100 mb-6 text-center">
                    <h4 class="text-blue-800 font-bold mb-2">๐ค ุจูุงูุงุช ุงูุนููู</h4>
                    <p class="text-xl font-extrabold text-gray-800 mb-1" x-text="selectedOrder.Customer_Name"></p>
                    <p class="text-sm font-mono text-gray-500 bg-white px-2 rounded inline-block border border-blue-100" x-text="selectedOrder.Phone"></p>
                    
                    <div class="flex justify-center gap-2 mt-4">
                        <a :href="'tel:'+selectedOrder.Phone" class="bg-white text-blue-600 px-4 py-2 rounded-lg border border-blue-200 hover:bg-blue-600 hover:text-white transition text-xs font-bold flex items-center gap-1">๐ ุงุชุตุงู</a>
                        <button @click="openWhatsapp(selectedOrder.Phone)" class="bg-green-100 text-green-700 px-4 py-2 rounded-lg border border-green-200 hover:bg-green-600 hover:text-white transition text-xs font-bold flex items-center gap-1">๐ฌ ูุงุชุณุงุจ</button>
                    </div>
                    
                    <div class="mt-3 pt-3 border-t border-blue-200">
                        <p class="text-xs text-gray-500 mb-1">ุงูุนููุงู ูุงููููุน:</p>
                        <p class="text-sm text-gray-800 mb-2 leading-snug" x-text="selectedOrder.Address"></p>
                        <a :href="getMapLink(selectedOrder.Location_Link)" target="_blank" class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-xs font-bold hover:bg-yellow-200 inline-block">๐ ุนุฑุถ ุงููููุน ุนูู ุงูุฎุฑูุทุฉ</a>
                    </div>
                </div>

                <div class="mt-auto">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-sm font-bold text-gray-500">ุชุบููุฑ ุงูุญุงูุฉ:</span>
                        <select x-model="selectedOrder.Status" @change="updateStatus(selectedOrder.Order_ID, $event.target.value)" class="border border-gray-300 rounded-lg px-3 py-1 text-sm bg-white focus:border-blue-500 outline-none w-1/2">
                            <option>ุฌุฏูุฏ</option><option>ุฌุงุฑู ุงูุชุญุถูุฑ</option><option>ุชู ุงูุงุฑุณุงู</option><option>ููุบู</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input x-model="printNote" placeholder="ุงูุชุจ ููุงุญุธุฉ ููุญูุธ ูุงูุทุจุงุนุฉ..." class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none">
                        <button @click="saveNote()" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-lg text-xs font-bold hover:bg-gray-200">๐พ ุญูุธ</button>
                        <button @click="printReceipt(selectedOrder, printNote)" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-black flex items-center gap-2">๐จ๏ธ ุทุจุงุนุฉ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div x-show="showProductModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4"><div class="bg-white rounded-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4 text-center">ุฅุฏุงุฑุฉ ุงูููุชุฌ</h3><div class="space-y-3"><input x-model="editingProduct.Name" placeholder="ุงุณู ุงูููุชุฌ" class="w-full border p-2 rounded"><div class="flex gap-2"><input x-model="editingProduct.Price" type="number" placeholder="ุงูุณุนุฑ" class="w-1/2 border p-2 rounded"><input x-model="editingProduct.Cost" type="number" placeholder="ุงูุชูููุฉ" class="w-1/2 border p-2 rounded text-red-500"></div><select x-model="editingProduct.Category" class="w-full border p-2 rounded"><option>ุงูููุชุฌุงุช ุงูุชุฑุงุซูุฉ</option><option>ุฃููุงุช ุชุฑุงุซูุฉ</option><option>ุฃุฌุจุงู ูุฃูุจุงู</option><option>ูููุฉ ูุฒูุช</option><option>ูุญูู ููุนูุจุงุช</option><option>ุจูุงุฑุงุช ูุชูุงุจู</option><option>ุญูููุงุช</option><option>ููุณุฑุงุช</option><option>ุฃุฏูุงุช ููุฒููุฉ</option></select><select x-model="editingProduct.Available" class="w-full border p-2 rounded"><option value="TRUE">ูุชุงุญ</option><option value="FALSE">ุบูุฑ ูุชุงุญ</option></select></div><div class="mt-6 flex gap-2"><button @click="saveProduct()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ุญูุธ</button><button @click="showProductModal=false" class="flex-1 bg-gray-100 text-gray-600 py-2 rounded font-bold">ุฅูุบุงุก</button></div></div></div>

    <div x-show="showNewOrderAlert" x-transition class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 bg-gray-900 text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-4 animate-bounce border-2 border-green-500 cursor-pointer" @click="showNewOrderAlert=false; currentTab='orders'">
        <span class="text-2xl">๐</span><div><h4 class="font-bold text-sm">ููุฌุฏ ุทูุจ ุฌุฏูุฏ!</h4><p class="text-[10px] text-gray-300">ุงุถุบุท ูููุนุงููุฉ</p></div>
    </div>
    
    <div id="printable-area"></div>

    <script>
        function adminPanel() {
            return {
                currentTab: 'dashboard', loading: false, searchQuery: '', dateFilter: 'all', customStartDate:'', customEndDate:'',
                orders: [], filteredOrders: [], products: [], productFilter: 'all',
                stats: { totalRevenue: 0, totalOrders: 0 }, reportStats: { today: 0, week: 0, month: 0 },
                financials: { netProfit: 0, margin: 0, aov: 0, returningRate: 0, deadStock: 0, topProfitable: [] },
                newOrdersCount: 0, lastOrderId: 0, showNewOrderAlert: false, expandedCard: null,
                showModal: false, showProductModal: false, selectedOrder: {}, editingProduct: {}, printNote: '', lastUpdate: '-', currentTimeDate: '', chartInstance: null,
                
                // โ๏ธ ุงูุฑุงุจุท ุงููุซุจุช
                scriptURL: "https://script.google.com/macros/s/AKfycbwhiiH9aTstbgI9xzsbKvoqKXxAo1UIovig2DRXSGYyupyuGhvlwTcsuGOSSNZQzo_5/exec",

                init() { 
                    this.fetchData(); 
                    setInterval(() => this.checkForUpdates(), 10000); 
                    setInterval(() => { this.currentTimeDate = new Date().toLocaleDateString('ar-EG', { weekday: 'long', hour: '2-digit', minute:'2-digit' }); }, 1000);
                },
                switchTab(tab) { this.currentTab = tab; if (tab === 'reports') setTimeout(() => this.renderChart(), 300); },

                getWhatsappLink(phone) { if (!phone) return '#'; let p = String(phone).replace(/\D/g, ''); if (p.startsWith('0')) p = p.substring(1); return `https://wa.me/2${p}`; },
                openWhatsapp(phone) { window.open(this.getWhatsappLink(phone), '_blank'); },
                getMapLink(link) { if (link && link.includes('googleusercontent')) { const m = link.match(/query=([\d\.]+),([\d\.]+)/); if (m) return `http://googleusercontent.com/maps.google.com/?api=1&query=${m[1]},${m[2]}`; } return link || '#'; },

                async fetchData() {
                    this.loading = true;
                    try {
                        const res = await fetch(this.scriptURL + '?action=getJSON&t=' + Date.now()); 
                        const data = await res.json();
                        this.orders = (data.orders || []).map(o => ({...o, Total_Amount: parseFloat(String(o.Total_Amount).replace(/[^0-9.]/g, '')) || 0, dateObj: new Date(o.Date), Status: o.Status || 'ุฌุฏูุฏ'})).sort((a, b) => b.dateObj - a.dateObj);
                        this.products = (data.products || []).map(p => ({...p, Price: Number(p.Price)||0, OldPrice: Number(p.OldPrice)||0, Cost: Number(p.Cost)||0}));
                        
                        if(this.orders.length > 0) {
                            const maxId = Math.max(...this.orders.map(o => Number(o.Order_ID) || 0));
                            if (this.lastOrderId === 0) this.lastOrderId = maxId;
                            // ุชุญุฏูุซ ุญุงูุฉ ุงูุชูุจูู ุฅุฐุง ูุงู ููุงู ุทูุจุงุช ุฌุฏูุฏุฉ ูู ุชุนุงูุฌ
                            const newOrders = this.orders.filter(o => o.Status === 'ุฌุฏูุฏ').length;
                            this.newOrdersCount = newOrders;
                            if (newOrders > 0) this.showNewOrderAlert = true;
                        }
                        this.updateView(); this.lastUpdate = new Date().toLocaleTimeString('ar-EG');
                    } catch(e) {} finally { this.loading = false; }
                },

                async checkForUpdates() {
                    try {
                        const res = await fetch(this.scriptURL + '?action=getJSON&t=' + Date.now()); const data = await res.json();
                        const latestIds = (data.orders || []).map(o => Number(o.Order_ID) || 0);
                        const maxId = Math.max(...latestIds);
                        if (maxId > this.lastOrderId) { this.lastOrderId = maxId; this.fetchData(); } // ุฌูุจ ุงูุจูุงูุงุช ุฅุฐุง ุฒุงุฏ ุงูุฑูู
                    } catch(e) {}
                },

                // ุจุงูู ุงูููุทู (ุจุฏูู ุชุบููุฑ ูุถูุงู ุงูุซุจุงุช)
                updateView() { this.filterList(); this.calculateStats(); this.calculateReports(); if(this.currentTab === 'reports') this.renderChart(); },
                filterList() {
                    let list = this.orders; const now = new Date(); now.setHours(0,0,0,0);
                    if (this.dateFilter === 'today') list = list.filter(o => { const d=new Date(o.Date); d.setHours(0,0,0,0); return d.getTime() === now.getTime(); });
                    if (this.dateFilter === 'week') { const w=new Date(now); w.setDate(now.getDate()-7); list = list.filter(o => new Date(o.Date) >= w); }
                    if (this.dateFilter === 'month') { const m=new Date(now); m.setMonth(now.getMonth()-1); list = list.filter(o => new Date(o.Date) >= m); }
                    if (this.dateFilter === 'custom' && this.customStartDate && this.customEndDate) { const s=new Date(this.customStartDate); const e=new Date(this.customEndDate); e.setHours(23,59,59); list = list.filter(o => { const d = new Date(o.Date); return d >= s && d <= e; }); }
                    if (this.searchQuery) { const q=this.searchQuery.toLowerCase(); list = list.filter(o => String(o.Order_ID).includes(q) || (o.Customer_Name||'').toLowerCase().includes(q) || String(o.Phone).includes(q)); }
                    this.filteredOrders = list;
                },
                
                // ุญูุธ ุงูููุงุญุธุฉ ูู ุงูุดูุช
                async saveNote() {
                    if(!this.selectedOrder.Order_ID) return;
                    // ุชุญุฏูุซ ูุญูู
                    this.selectedOrder.Note = this.printNote;
                    // ุชุญุฏูุซ ุณูุฑูุฑ
                    await fetch(this.scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'save_note', orderId: this.selectedOrder.Order_ID, note: this.printNote }) });
                    alert('ุชู ุญูุธ ุงูููุงุญุธุฉ');
                },

                // ุฏูุงู ุงููุณุงุนุฏุฉ ุงููุนุชุงุฏุฉ (parseOrderDetails, printReceipt, etc.)
                parseOrderDetails(s) { if (!s) return []; return s.split('|').map(l => { const m = l.match(/^(.*?)\s*\((\d+)\)\s*-\s*(\d+)/); if (m) return { name: m[1].trim(), qty: Number(m[2]), price: Number(m[3]) }; const old = l.match(/^(.*?)\s*\((\d+)\)/); return old ? { name: old[1].trim(), qty: Number(old[2]), price: 0 } : { name: l.trim(), qty: 1, price: 0 }; }); },
                formatMoney(n) { return Number(n).toLocaleString('en-US') + ' ุฌ'; },
                getStatusColor(s) { return {'ุฌุฏูุฏ':'bg-red-100 text-red-800','ุชู ุงูุงุฑุณุงู':'bg-blue-100 text-blue-800','ุชู ุงูุชุณููู':'bg-green-100 text-green-800'}[s] || 'bg-gray-100'; },
                openModal(o) { this.selectedOrder = o; this.printNote = o.Note || ''; this.showModal = true; },
                updateStatus(id, s) { fetch(this.scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'update_status', orderId: id, newStatus: s }) }); const idx=this.orders.findIndex(o=>o.Order_ID==id); if(idx>-1) this.orders[idx].Status=s; },
                // ... (ุจุงูู ุงูุฏูุงู ุงูุญุณุงุจูุฉ ูุงูุชุดุงุฑุช ููุณ ุงูููุฏ ุงูุณุงุจู) ...
                calculateStats() { this.stats.totalRevenue = this.orders.reduce((s,o)=>s+o.Total_Amount,0); this.stats.totalOrders = this.orders.length; },
                calculateReports() { const now=new Date(); now.setHours(0,0,0,0); const week=new Date(now); week.setDate(now.getDate()-7); const month=new Date(now); month.setDate(1); this.reportStats = { today:0, week:0, month:0 }; let totalCost = 0; const productSales = {}; this.orders.forEach(o => { const d=new Date(o.Date); d.setHours(0,0,0,0); if(d.getTime()===now.getTime()) this.reportStats.today+=o.Total_Amount; if(d>=w) this.reportStats.week+=o.Total_Amount; if(d>=m) this.reportStats.month+=o.Total_Amount; const items = this.parseOrderDetails(o.Order_Details); items.forEach(item => { const product = this.products.find(p => p.Name.trim() === item.name.trim()); if(product) { totalCost += (product.Cost * item.qty); productSales[product.Name] = (productSales[product.Name] || 0) + item.qty; } }); }); this.financials.netProfit = this.stats.totalRevenue - totalCost; this.financials.margin = this.stats.totalRevenue > 0 ? Math.round((this.financials.netProfit / this.stats.totalRevenue) * 100) : 0; this.financials.aov = this.stats.totalOrders > 0 ? this.stats.totalRevenue / this.stats.totalOrders : 0; const customerCounts = {}; this.orders.forEach(o => { customerCounts[String(o.Phone)] = (customerCounts[String(o.Phone)] || 0) + 1; }); const returningCount = Object.values(customerCounts).filter(c => c > 1).length; this.financials.returningRate = Object.keys(customerCounts).length > 0 ? Math.round((returningCount / Object.keys(customerCounts).length) * 100) : 0; this.financials.deadStock = this.products.filter(p => !productSales[p.Name]).length; this.financials.topProfitable = this.products.map(p => ({ name: p.Name, profit: (p.Price - p.Cost) * (productSales[p.Name] || 0) })).sort((a,b) => b.profit - a.profit).slice(0, 5); },
                renderChart() { const ctx=document.getElementById('financialChart'); if(!ctx) return; if(this.chartInstance) this.chartInstance.destroy(); const l=[],d=[]; for(let i=6; i>=0; i--) { const dt=new Date(); dt.setDate(dt.getDate()-i); dt.setHours(0,0,0,0); l.push(dt.toLocaleDateString('ar-EG',{weekday:'short'})); d.push(this.orders.filter(o=>{ const od=new Date(o.Date); od.setHours(0,0,0,0); return od.getTime()===dt.getTime(); }).reduce((s,o)=>s+o.Total_Amount,0)); } this.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: l, datasets: [{ label: 'ุงููุจูุนุงุช', data: d, backgroundColor: '#166534', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false } }); },
                getBestSellers() { const c={}; this.orders.forEach(o=>{ (o.Order_Details||'').split('|').forEach(i=>{ const m=i.match(/^(.*?)\s*\(/); const n=m?m[1].trim():i.trim(); if(n)c[n]=(c[n]||0)+1; }); }); return Object.entries(c).map(([n,v])=>({name:n,count:v})).sort((a,b)=>b.count-a.count).slice(0,10); },
                getExpandedData() { if(this.expandedCard==='new_orders')return this.orders.filter(o=>o.Status==='ุฌุฏูุฏ'); if(this.expandedCard==='today_sales'){const t=new Date();t.setHours(0,0,0,0);return this.orders.filter(o=>{const d=new Date(o.Date);d.setHours(0,0,0,0);return d.getTime()===t.getTime()});} return this.orders; },
                getExpandedTitle() { const t={'revenue':'ุงููุจูุนุงุช','orders_count':'ุงูุทูุจุงุช','new_orders':'ุงูุฌุฏูุฏุฉ','today_sales':'ุงูููู','best_sellers':'ุงูุฃูุถู'}; return t[this.expandedCard]; },
                toggleCard(c) { this.expandedCard = this.expandedCard === c ? null : c; },
                printReceipt(order, note) { const items = this.parseOrderDetails(order.Order_Details).map(i => `<tr><td style="text-align:right">${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:center">${i.price}</td></tr>`).join(''); const html = `<div style="text-align:center;border-bottom:1px dashed #333;padding-bottom:10px;margin-bottom:10px"><h2 style="margin:0">ููุชุฌุงุช ูุฏููุชู</h2><p style="font-size:10px">#${order.Order_ID} | ${order.Date.split(',')[0]}</p></div><div style="font-size:11px;text-align:right"><p>ุงูุนููู: ${order.Customer_Name}</p><p>ุช: ${order.Phone}</p></div><table style="width:100%;font-size:11px;border-top:1px dashed #333;margin-top:10px" dir="rtl"><thead><tr><th style="text-align:right">ุตูู</th><th>ุนุฏุฏ</th><th>ุณุนุฑ</th></tr></thead><tbody>${items}</tbody></table>${note?`<p style="font-size:10px;border-top:1px dashed #333;padding-top:5px">ููุงุญุธุฉ: ${note}</p>`:''}<div style="margin-top:10px;font-weight:bold;display:flex;justify-content:space-between"><span>ุงูุฅุฌูุงูู:</span><span>${this.formatMoney(order.Total_Amount)}</span></div><div style="text-align:center;font-size:9px;margin-top:15px">ุดูุฑุงู ูุฒูุงุฑุชูู</div>`; document.getElementById('printable-area').innerHTML = html; window.print(); }
            }
        }
    </script>
</body>
</html>
