<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุฅุฏุงุฑุฉ ููุชุฌุงุช ูุฏููุชู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .nav-item.active { background-color: #dcfce7; color: #166534; border-right: 4px solid #166534; }
        .glass { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        [x-cloak] { display: none !important; }
        .status-badge { padding: 4px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .animate-pulse-bg { animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { background-color: #fecaca; } 50% { background-color: #fee2e2; } 100% { background-color: #fecaca; } }
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 80mm; }
        }
    </style>
</head>
<body class="text-slate-800" x-data="adminPanel()">

    <div class="flex h-screen overflow-hidden">
        
        <aside class="w-72 bg-white border-l flex-shrink-0 hidden md:flex flex-col z-20 shadow-lg">
            <div class="p-6 border-b border-dashed flex flex-col items-center justify-center text-center bg-green-50">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl mb-2">ู</div>
                <h1 class="font-extrabold text-xl text-green-900 leading-tight">ููุญุฉ ุฅุฏุงุฑุฉ<br>ููุชุฌุงุช ูุฏููุชู</h1>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button @click="currentTab = 'dashboard'" :class="currentTab === 'dashboard' ? 'active' : ''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition">
                    <span class="text-xl">๐</span> <span class="font-bold">ููุญุฉ ุงูุนุฑุถ</span>
                </button>
                <button @click="currentTab = 'orders'" :class="currentTab === 'orders' ? 'active' : ''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition">
                    <span class="text-xl">๐ฆ</span> <span class="font-bold">ุณุฌู ุงูุทูุจุงุช</span>
                </button>
                <button @click="currentTab = 'products'" :class="currentTab === 'products' ? 'active' : ''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition">
                    <span class="text-xl">๐ท๏ธ</span> <span class="font-bold">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</span>
                </button>
                <button @click="currentTab = 'customers'" :class="currentTab === 'customers' ? 'active' : ''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition">
                    <span class="text-xl">๐ฅ</span> <span class="font-bold">ุงูุนููุงุก ูุงูููุงุก</span>
                </button>
                <button @click="switchTab('reports')" :class="currentTab === 'reports' ? 'active' : ''" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 rounded-lg hover:bg-gray-50 transition">
                    <span class="text-xl">๐</span> <span class="font-bold">ุงูุชูุงุฑูุฑ ุงููุงููุฉ</span>
                </button>
            </nav>

            <div class="p-4 border-t bg-gray-50 mt-auto">
                <a href="https://wa.me/201032825648" target="_blank" class="flex flex-col items-center justify-center text-center group cursor-pointer">
                    <span class="text-[10px] text-gray-400 mb-1">ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ</span>
                    <div class="flex items-center gap-2 text-green-700 font-bold text-sm group-hover:text-green-600 transition">
                        <span>๐ฌ</span> ุชุตููู ู ุจุฑูุฌุฉ ู. ุนูุฏ ุงูุงุบุง
                    </div>
                </a>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-slate-50">
            
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-2xl font-extrabold text-slate-800" x-text="pageTitle"></h2>
                    <p class="text-xs text-gray-500 mt-1">ุขุฎุฑ ุชุญุฏูุซ: <span x-text="lastUpdate"></span></p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative cursor-pointer p-2 hover:bg-white rounded-full transition" @click="currentTab = 'orders'; showNewOrderAlert = false; newOrdersCount = 0;">
                        <span class="text-3xl">๐</span>
                        <span x-show="newOrdersCount > 0" x-transition.scale class="absolute top-0 right-0 bg-red-600 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-50 shadow-sm animate-pulse" x-text="newOrdersCount"></span>
                    </div>
                    <button @click="fetchData()" class="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-xl text-sm font-bold shadow-sm transition flex items-center gap-2">
                        <span x-show="loading" class="animate-spin">โป</span> ุชุญุฏูุซ
                    </button>
                </div>
            </div>

            <div x-show="currentTab === 'dashboard'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div @click="toggleCard('revenue')" class="glass p-4 border-b-4 border-green-500 cursor-pointer hover:bg-green-50 transition transform active:scale-95"><p class="text-[10px] font-bold uppercase text-gray-500">ุฅุฌูุงูู ุงููุจูุนุงุช</p><p class="text-xl font-extrabold mt-1 text-slate-800" x-text="formatMoney(stats.totalRevenue)"></p><p class="text-[9px] text-gray-400 mt-1">โผ ุงูุชูุงุตูู</p></div>
                    <div @click="toggleCard('orders_count')" class="glass p-4 border-b-4 border-blue-500 cursor-pointer hover:bg-blue-50 transition transform active:scale-95"><p class="text-[10px] font-bold uppercase text-gray-500">ุนุฏุฏ ุงูุทูุจุงุช</p><p class="text-xl font-extrabold mt-1 text-slate-800" x-text="stats.totalOrders"></p><p class="text-[9px] text-gray-400 mt-1">โผ ุงูุชูุงุตูู</p></div>
                    <div @click="toggleCard('new_orders')" class="glass p-4 border-b-4 border-yellow-500 cursor-pointer hover:bg-yellow-50 transition transform active:scale-95"><p class="text-[10px] font-bold uppercase text-gray-500">ุทูุจุงุช ุฌุฏูุฏุฉ</p><p class="text-xl font-extrabold mt-1 text-slate-800" x-text="orders.filter(o => o.Status === 'ุฌุฏูุฏ').length"></p><p class="text-[9px] text-gray-400 mt-1">โผ ุงูุชูุงุตูู</p></div>
                    <div @click="toggleCard('today_sales')" class="glass p-4 border-b-4 border-purple-500 cursor-pointer hover:bg-purple-50 transition transform active:scale-95"><p class="text-[10px] font-bold uppercase text-gray-500">ูุจูุนุงุช ุงูููู</p><p class="text-xl font-extrabold mt-1 text-slate-800" x-text="formatMoney(reportStats.today)"></p><p class="text-[9px] text-gray-400 mt-1">โผ ุงูุชูุงุตูู</p></div>
                    <div @click="toggleCard('best_sellers')" class="glass p-4 border-b-4 border-orange-500 cursor-pointer hover:bg-orange-50 transition transform active:scale-95"><p class="text-[10px] font-bold uppercase text-gray-500">ุงูุฃูุซุฑ ูุจูุนุงู</p><p class="text-xl font-extrabold mt-1">๐ฅ Top 10</p><p class="text-[9px] text-gray-400 mt-1">โผ ุงูุชูุงุตูู</p></div>
                </div>
                <div x-show="expandedCard" x-transition class="mb-8 glass p-6 border-t-4 border-gray-800 bg-white"><div class="flex justify-between mb-4"><h3 class="font-bold text-lg" x-text="getExpandedTitle()"></h3><button @click="expandedCard=null" class="text-red-500 hover:text-red-700 font-bold text-sm">โ ุฅุบูุงู</button></div><div class="overflow-x-auto max-h-80"><table x-show="expandedCard==='best_sellers'" class="w-full text-sm text-right"><thead class="bg-orange-100"><tr><th>#</th><th>ุงูููุชุฌ</th><th>ุงูุนุฏุฏ</th></tr></thead><tbody><template x-for="(i,x) in getBestSellers()" :key="x"><tr class="border-b hover:bg-orange-50"><td x-text="x+1"></td><td x-text="i.name"></td><td class="font-bold text-orange-600" x-text="i.count"></td></tr></template></tbody></table><table x-show="expandedCard!=='best_sellers'" class="w-full text-sm text-right"><thead class="bg-gray-100"><tr><th>#</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุนููู</th><th>ุงููุจูุบ</th><th>ุงูุญุงูุฉ</th></tr></thead><tbody><template x-for="i in getExpandedData()" :key="i.Order_ID"><tr class="border-b hover:bg-gray-50 cursor-pointer" @click="openModal(i)"><td class="font-mono" x-text="i.Order_ID"></td><td class="text-xs" x-text="i.Date"></td><td x-text="i.Customer_Name"></td><td class="font-bold text-green-600" x-text="formatMoney(i.Total_Amount)"></td><td><span class="px-2 py-1 rounded text-xs" :class="getStatusColor(i.Status)" x-text="i.Status"></span></td></tr></template></tbody></table></div></div>
            </div>

            <div x-show="currentTab === 'orders'" x-transition>
                <div class="glass p-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="flex-1"><label class="text-xs font-bold text-gray-500 block mb-1">ุจุญุซ</label><input x-model="searchQuery" @input="filterList()" type="text" placeholder="ุงุณูุ ุฑููุ ููุฏ..." class="w-full border p-2 rounded-lg text-sm focus:outline-none focus:border-green-500"></div>
                        <div><label class="text-xs font-bold text-gray-500 block mb-1">ุชุตููุฉ</label><select x-model="dateFilter" @change="filterList()" class="border p-2 rounded-lg text-sm bg-white w-full md:w-40"><option value="all">ุงููู</option><option value="today">ุงูููู</option><option value="week">ุงูุฃุณุจูุน</option><option value="month">ุงูุดูุฑ</option><option value="custom">ูุฎุตุต</option></select></div>
                        <div x-show="dateFilter==='custom'" class="flex gap-2"><div><label class="text-[10px] block">ูู</label><input type="date" x-model="customStartDate" @change="filterList()" class="border p-1.5 rounded-lg text-sm"></div><div><label class="text-[10px] block">ุฅูู</label><input type="date" x-model="customEndDate" @change="filterList()" class="border p-1.5 rounded-lg text-sm"></div></div>
                    </div>
                    <div class="overflow-x-auto rounded-lg border border-gray-100 bg-white">
                        <table class="w-full text-sm text-right">
                            <thead class="bg-gray-50 text-gray-600 font-bold sticky top-0"><tr><th class="p-3">#</th><th class="p-3">ุงูุชุงุฑูุฎ</th><th class="p-3">ุงูุนููู</th><th class="p-3">ุงููุงุชู</th><th class="p-3 text-center">ุงูุญุงูุฉ</th><th class="p-3">ุงูุฅุฌูุงูู</th><th class="p-3 text-center"></th></tr></thead>
                            <tbody class="divide-y divide-gray-100"><template x-for="o in filteredOrders" :key="o.Order_ID"><tr class="hover:bg-gray-50 transition cursor-pointer" @click="openModal(o)"><td class="font-mono text-gray-700 p-3" x-text="'#'+o.Order_ID"></td><td class="text-xs text-gray-500 p-3"><div x-text="o.Date.split(',')[0]"></div><div class="text-[10px]" x-text="o.Date.split(',')[1]"></div></td><td class="font-bold text-gray-800 p-3" x-text="o.Customer_Name"></td><td class="font-mono text-gray-500 p-3" x-text="o.Phone"></td><td class="text-center p-3"><span class="status-badge" :class="o.Status==='ุฌุฏูุฏ'?'bg-red-500 text-white animate-pulse-bg':getStatusColor(o.Status)" x-text="o.Status"></span></td><td class="font-bold text-green-600 p-3" x-text="formatMoney(o.Total_Amount)"></td><td class="text-center p-3"><button class="text-blue-500 border border-blue-200 px-2 py-1 rounded text-xs">ุนุฑุถ</button></td></tr></template></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div x-show="currentTab === 'products'" x-transition>
                <div class="glass p-6">
                    <div class="flex justify-between mb-6"><h3 class="font-bold text-lg">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</h3><button @click="openProductModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold">+ ุฅุถุงูุฉ</button></div>
                    <div class="flex overflow-x-auto gap-2 mb-4 pb-2"><button @click="productFilter='all'" :class="productFilter==='all'?'bg-green-600 text-white':'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition">ุงููู</button><template x-for="c in fixedCategories" :key="c"><button @click="productFilter=c" :class="productFilter===c?'bg-green-600 text-white':'bg-gray-100 text-gray-600'" class="px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition" x-text="c"></button></template></div>
                    <div class="overflow-x-auto rounded-lg border border-gray-100">
                        <table class="w-full text-sm text-right bg-white"><thead class="bg-gray-50 font-bold"><tr><th class="p-3">ุงููุณู</th><th class="p-3">ุงูุงุณู</th><th class="p-3">ุงูุณุนุฑ</th><th class="p-3">ุงูุญุงูุฉ</th><th class="p-3 text-center">ุชุญูู</th></tr></thead><tbody class="divide-y"><template x-for="p in getFilteredProducts()" :key="p.ID"><tr class="hover:bg-gray-50"><td class="text-xs text-gray-500 p-3" x-text="p.Category"></td><td class="font-bold p-3" x-text="p.Name"></td><td class="text-green-600 p-3" x-text="p.Price+' ุฌ'"></td><td class="text-xs p-3" x-text="p.Available==='TRUE'?'โ':'โ'"></td><td class="flex justify-center gap-2 p-3"><button @click="openProductModal(p)" class="text-blue-600 bg-blue-50 p-1 rounded">โ๏ธ</button><button @click="deleteProduct(p.ID)" class="text-red-600 bg-red-50 p-1 rounded">๐๏ธ</button></td></tr></template></tbody></table>
                    </div>
                </div>
            </div>

            <div x-show="currentTab === 'customers'" x-transition>
                <div class="glass p-6">
                    <h3 class="font-bold mb-4">ูุงุฆูุฉ ุงูุนููุงุก (ุงูููุงุก)</h3>
                    <div class="overflow-x-auto"><table class="w-full text-sm text-right bg-white"><thead class="bg-gray-100 font-bold"><tr><th class="p-3">ุงูุนููู</th><th class="p-3 text-center">ุชูุงุตู</th><th class="p-3">ุงูุชุตููู</th><th class="p-3">ุงูููุงูุฃุฉ</th><th class="p-3">ุฅุฌูุงูู ุงูุฅููุงู</th></tr></thead><tbody class="divide-y"><template x-for="c in uniqueCustomers" :key="c.phone"><tr class="hover:bg-gray-50"><td class="p-3 font-bold" x-text="c.name"></td><td class="p-3 flex justify-center gap-2"><a :href="'tel:'+c.phone" class="bg-blue-100 text-blue-600 p-2 rounded-full hover:bg-blue-200">๐</a><a :href="'https://wa.me/2'+c.phone.replace(/^0/,'')" target="_blank" class="bg-green-100 text-green-600 p-2 rounded-full hover:bg-green-200">๐ฌ</a></td><td class="p-3"><span class="block text-xs font-bold px-2 py-1 rounded inline-block text-center w-24" :class="getLoyalty(c).color" x-text="getLoyalty(c).label"></span></td><td class="p-3 text-xs text-gray-600" x-text="getLoyalty(c).offer"></td><td class="p-3 font-bold text-green-600" x-text="formatMoney(c.total)"></td></tr></template></tbody></table></div>
                </div>
            </div>

            <div x-show="currentTab === 'reports'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-6 text-center border-t-4 border-green-500"><h4 class="text-gray-500 font-bold">ุฅูุฑุงุฏุงุช ุงูููู</h4><p class="text-3xl font-extrabold text-green-700 mt-2" x-text="formatMoney(reportStats.today)"></p></div>
                    <div class="glass p-6 text-center border-t-4 border-blue-500"><h4 class="text-gray-500 font-bold">ุฅูุฑุงุฏุงุช ุงูุฃุณุจูุน</h4><p class="text-3xl font-extrabold text-blue-700 mt-2" x-text="formatMoney(reportStats.week)"></p></div>
                    <div class="glass p-6 text-center border-t-4 border-purple-500"><h4 class="text-gray-500 font-bold">ุฅูุฑุงุฏุงุช ุงูุดูุฑ</h4><p class="text-3xl font-extrabold text-purple-700 mt-2" x-text="formatMoney(reportStats.month)"></p></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass p-6"><h3 class="font-bold text-gray-700 mb-4 border-b pb-2">๐ ุงูุฃูุซุฑ ูุจูุนุงู</h3><table class="w-full text-sm text-right"><thead class="bg-gray-50"><tr><th>ุงูููุชุฌ</th><th class="text-center">ุงูุนุฏุฏ</th></tr></thead><tbody class="divide-y"><template x-for="(i, x) in getBestSellers().slice(0,5)" :key="x"><tr><td class="py-2" x-text="i.name"></td><td class="py-2 text-center font-bold text-emerald-600" x-text="i.count"></td></tr></template></tbody></table></div>
                    <div class="glass p-6"><h3 class="font-bold text-gray-700 mb-4 border-b pb-2">ุชุญููู ุงููุจูุนุงุช</h3><div class="h-64 w-full relative"><canvas id="financialChart"></canvas></div></div>
                </div>
            </div>

        </main>
    </div>

    <div x-show="showModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4 backdrop-blur-sm" @click.self="showModal = false">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg">ุชูุงุตูู ุงูุทูุจ #<span x-text="selectedOrder.Order_ID"></span></h3><button @click="showModal = false">โ</button></div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="font-bold text-blue-700 mb-3 flex items-center gap-2">๐ค ุงูุนููู</h4>
                    <p class="font-bold text-gray-800" x-text="selectedOrder.Customer_Name"></p>
                    <p class="text-sm text-gray-600 font-mono my-1" x-text="selectedOrder.Phone"></p>
                    <div class="flex gap-2 mt-3">
                        <a :href="'tel:' + selectedOrder.Phone" class="bg-white text-blue-600 p-1.5 rounded border border-blue-200 hover:bg-blue-100">๐</a>
                        <a :href="'https://wa.me/2' + String(selectedOrder.Phone || '').replace(/^0/,'').replace(/'/g,'')" target="_blank" class="bg-green-100 text-green-600 p-1.5 rounded border border-green-200 hover:bg-green-200">๐ฌ</a>
                        <a x-show="selectedOrder.Location_Link" :href="selectedOrder.Location_Link" target="_blank" class="bg-yellow-100 text-yellow-700 p-1.5 rounded border border-yellow-200 text-xs font-bold hover:bg-yellow-200">๐ ุงููููุน</a>
                    </div>
                </div>
                <div class="md:col-span-1 bg-green-50 p-4 rounded-xl border border-green-100 flex flex-col">
                    <h4 class="font-bold text-green-700 mb-3">๐งพ ุงููุงุชูุฑุฉ</h4>
                    <div class="bg-white rounded border border-green-200 overflow-y-auto flex-1 h-32 mb-2 p-2 text-sm">
                        <template x-for="item in parseOrderDetails(selectedOrder.Order_Details)">
                            <div class="flex justify-between border-b border-dashed last:border-0 py-1">
                                <span><span class="text-green-600">โข</span> <span x-text="item.name"></span> x<span x-text="item.qty"></span></span>
                                <span class="font-bold" x-text="item.price > 0 ? item.price*item.qty : ''"></span>
                            </div>
                        </template>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-green-200 font-bold text-lg text-green-800"><span>ุงูุฅุฌูุงูู:</span><span x-text="formatMoney(selectedOrder.Total_Amount)"></span></div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 border-t flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2"><span class="text-sm font-bold text-gray-600">ุงูุญุงูุฉ:</span><select x-model="selectedOrder.Status" @change="updateStatus(selectedOrder.Order_ID, $event.target.value)" class="border p-2 rounded bg-white text-sm"><option value="ุฌุฏูุฏ">๐ต ุฌุฏูุฏ</option><option value="ุฌุงุฑู ุงูุชุญุถูุฑ">๐ ุฌุงุฑู ุงูุชุญุถูุฑ</option><option value="ุชู ุงูุงุฑุณุงู">๐ข ุชู ุงูุงุฑุณุงู</option><option value="ููุบู">๐ด ููุบู</option></select></div>
                <div class="flex gap-2"><textarea x-model="printNote" placeholder="ููุงุญุธุฉ..." class="border p-2 rounded text-sm w-32 h-10 resize-none"></textarea><button @click="printReceipt(selectedOrder, printNote)" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">๐จ๏ธ ุทุจุงุนุฉ ุญุฑุงุฑูุฉ</button></div>
            </div>
        </div>
    </div>

    <div x-show="showProductModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6">
            <h3 class="font-bold text-lg mb-4">ุฅุฏุงุฑุฉ ุงูููุชุฌ</h3>
            <div class="space-y-3">
                <input x-model="editingProduct.Name" type="text" placeholder="ุงูุงุณู" class="w-full border p-2 rounded">
                <div class="flex gap-2"><input x-model="editingProduct.Price" type="number" placeholder="ุงูุณุนุฑ" class="w-1/2 border p-2 rounded"><input x-model="editingProduct.OldPrice" type="number" placeholder="ุณุนุฑ ูุฏูู" class="w-1/2 border p-2 rounded"></div>
                <select x-model="editingProduct.Category" class="w-full border p-2 rounded"><template x-for="cat in fixedCategories" :key="cat"><option :value="cat" x-text="cat"></option></template></select>
                <select x-model="editingProduct.Available" class="w-full border p-2 rounded"><option value="TRUE">ูุชุงุญ</option><option value="FALSE">ุบูุฑ ูุชุงุญ</option></select>
            </div>
            <div class="mt-6 flex gap-2"><button @click="saveProduct()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">ุญูุธ</button><button @click="showProductModal = false" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-bold">ุฅูุบุงุก</button></div>
        </div>
    </div>
    
    <div x-show="showNewOrderAlert" x-transition class="fixed bottom-5 left-5 z-50 bg-gray-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 animate-bounce border-2 border-green-500 cursor-pointer" @click="showNewOrderAlert=false; fetchData(); currentTab='orders'">
        <span class="text-2xl">๐</span>
        <div><h4 class="font-bold">ุทูุจ ุฌุฏูุฏ ูุตู!</h4><p class="text-xs text-gray-300">ุงุถุบุท ููุนุฑุถ</p></div>
    </div>
    
    <div id="printable-area"></div>

    <script>
        function adminPanel() {
            return {
                currentTab: 'dashboard', loading: false, searchQuery: '', dateFilter: 'all', customStartDate:'', customEndDate:'',
                orders: [], filteredOrders: [], products: [], productFilter: 'all',
                fixedCategories: ['ุงูููุชุฌุงุช ุงูุชุฑุงุซูุฉ', 'ุฃููุงุช ุชุฑุงุซูุฉ', 'ุฃุฌุจุงู ูุฃูุจุงู', 'ูููุฉ ูุฒูุช', 'ูุญูู ููุนูุจุงุช', 'ุจูุงุฑุงุช ูุชูุงุจู', 'ุญูููุงุช', 'ููุณุฑุงุช', 'ุฃุฏูุงุช ููุฒููุฉ'],
                stats: { totalRevenue: 0, totalOrders: 0 }, reportStats: { today: 0, week: 0, month: 0 },
                newOrdersCount: 0, lastOrderId: 0, showNewOrderAlert: false, expandedCard: null,
                showModal: false, showProductModal: false, selectedOrder: {}, editingProduct: {}, printNote: '', lastUpdate: '-', chartInstance: null,
                
                // โ๏ธ ุงูุฑุงุจุท ูุซุจุช ููุง
                scriptURL: "https://script.google.com/macros/s/AKfycbwhiiH9aTstbgI9xzsbKvoqKXxAo1UIovig2DRXSGYyupyuGhvlwTcsuGOSSNZQzo_5/exec",

                get pageTitle() { const t={'dashboard':'ููุญุฉ ุงูุนุฑุถ','orders':'ุณุฌู ุงูุทูุจุงุช','products':'ุงูููุชุฌุงุช','customers':'ุงูุนููุงุก','reports':'ุงูุชูุงุฑูุฑ ุงููุงููุฉ'}; return t[this.currentTab]; },

                init() { this.fetchData(); setInterval(() => this.checkForUpdates(), 10000); }, // ูุญุต ูู 10 ุซูุงูู
                switchTab(tab) { this.currentTab = tab; if (tab === 'reports') setTimeout(() => this.renderChart(), 300); },

                async fetchData() {
                    this.loading = true;
                    // ๐ฅ ูุณุฑ ุงููุงุด ุจุฅุถุงูุฉ ููุช ุนุดูุงุฆู
                    const uniqueUrl = this.scriptURL + '?t=' + new Date().getTime();
                    try {
                        const res = await fetch(uniqueUrl); const data = await res.json();
                        this.orders = (data.orders || []).map(o => ({...o, Total_Amount: parseFloat(String(o.Total_Amount).replace(/[^0-9.]/g, '')) || 0, dateObj: new Date(o.Date), Status: o.Status || 'ุฌุฏูุฏ'})).sort((a, b) => b.dateObj - a.dateObj);
                        this.products = (data.products || []).map(p => ({...p, Price: Number(p.Price)||0, OldPrice: Number(p.OldPrice)||0}));
                        
                        // ุชููุฆุฉ ุขุฎุฑ ุฑูู ุทูุจ ุนูุฏ ุงููุชุญ ูุฃูู ูุฑุฉ
                        if(this.orders.length > 0 && this.lastOrderId === 0) { 
                            this.lastOrderId = Math.max(...this.orders.map(o => Number(o.Order_ID) || 0)); 
                        }
                        this.updateView(); this.lastUpdate = new Date().toLocaleTimeString('ar-EG');
                    } catch(e) { console.error(e); } finally { this.loading = false; }
                },

                // ุฅุตูุงุญ ููุทู ุงูุชูุจููุงุช (ูุน ูุณุฑ ุงููุงุด ุฃูุถุงู)
                async checkForUpdates() {
                    try {
                        const uniqueUrl = this.scriptURL + '?t=' + new Date().getTime();
                        const res = await fetch(uniqueUrl); const data = await res.json();
                        const latestIds = (data.orders || []).map(o => Number(o.Order_ID) || 0);
                        const maxId = Math.max(...latestIds);
                        
                        // ุฅุฐุง ูุฌุฏูุง ุฑูู ุทูุจ ุฃูุจุฑ ูู ุขุฎุฑ ุฑูู ูุนุฑูู
                        if (maxId > this.lastOrderId) {
                            const diff = latestIds.filter(id => id > this.lastOrderId).length;
                            if (diff > 0) {
                                this.newOrdersCount += diff;
                                this.showNewOrderAlert = true;
                                this.lastOrderId = maxId;
                                // ุชุญุฏูุซ ุงูุจูุงูุงุช ููุฑุงู ูู ุงูุฎูููุฉ
                                this.fetchData();
                            }
                        }
                    } catch(e) {}
                },

                updateView() { this.filterList(); this.calculateStats(); this.calculateReports(); if(this.currentTab === 'reports') this.renderChart(); },
                
                // ุงูููุงุชุฑ
                filterList() {
                    let list = this.orders; const now = new Date(); now.setHours(0,0,0,0);
                    if (this.dateFilter === 'today') list = list.filter(o => { const d=new Date(o.Date); d.setHours(0,0,0,0); return d.getTime() === now.getTime(); });
                    if (this.dateFilter === 'week') { const w=new Date(now); w.setDate(now.getDate()-7); list = list.filter(o => new Date(o.Date) >= w); }
                    if (this.dateFilter === 'month') { const m=new Date(now); m.setMonth(now.getMonth()-1); list = list.filter(o => new Date(o.Date) >= m); }
                    if (this.dateFilter === 'custom' && this.customStartDate && this.customEndDate) { const s=new Date(this.customStartDate); const e=new Date(this.customEndDate); e.setHours(23,59,59); list = list.filter(o => { const d = new Date(o.Date); return d >= s && d <= e; }); }
                    if (this.searchQuery) { const q=this.searchQuery.toLowerCase(); list = list.filter(o => String(o.Order_ID).includes(q) || (o.Customer_Name||'').toLowerCase().includes(q) || String(o.Phone).includes(q)); }
                    this.filteredOrders = list;
                },
                getFilteredProducts() { if (this.productFilter === 'all') return this.products; return this.products.filter(p => p.Category === this.productFilter); },

                toggleCard(card) { this.expandedCard = this.expandedCard === card ? null : card; },
                getExpandedTitle() { const t={'revenue':'ุชูุงุตูู ุงููุจูุนุงุช','orders_count':'ุณุฌู ุงูุทูุจุงุช','new_orders':'ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ','today_sales':'ูุจูุนุงุช ุงูููู','best_sellers':'ุงูุฃูุซุฑ ูุจูุนุงู'}; return t[this.expandedCard]; },
                getExpandedData() { if(this.expandedCard === 'new_orders') return this.orders.filter(o => o.Status === 'ุฌุฏูุฏ'); if(this.expandedCard === 'today_sales') { const t=new Date().setHours(0,0,0,0); return this.orders.filter(o => { const d=new Date(o.Date); d.setHours(0,0,0,0); return d.getTime() === t; }); } return this.orders; },
                getBestSellers() { const c={}; this.orders.forEach(o=>{ (o.Order_Details||'').split('|').forEach(i=>{ const m=i.match(/^(.*?)\s*\(/); const n=m?m[1].trim():i.trim(); if(n)c[n]=(c[n]||0)+1; }); }); return Object.entries(c).map(([n,v])=>({name:n,count:v})).sort((a,b)=>b.count-a.count).slice(0,10); },

                // ุงูุนููุงุก ูุงูููุงุก
                get uniqueCustomers() {
                    const map = {};
                    this.orders.forEach(o => {
                        const p = String(o.Phone).replace(/[^0-9]/g, '');
                        if(!map[p]) map[p] = { name: o.Customer_Name, phone: p, total: 0 };
                        map[p].total += o.Total_Amount;
                    });
                    return Object.values(map).sort((a,b) => b.total - a.total);
                },
                getLoyalty(c) {
                    if(c.total > 5000) return { label: '๐ VIP', color: 'text-yellow-600 bg-yellow-50', offer: 'ุฎุตู 15% + ุดุญู ูุฌุงูู' };
                    if(c.total > 2000) return { label: '๐ ููู', color: 'text-blue-600 bg-blue-50', offer: 'ููุจูู ุฎุตู 50ุฌ' };
                    return { label: '๐ ุฌุฏูุฏ', color: 'text-gray-500 bg-gray-100', offer: 'ุนุฑุถ ุชุฑุญูุจู' };
                },

                // ุฏูุงู ุงูุฅุฏุงุฑุฉ
                openProductModal(p={}) { this.editingProduct={...p, Available:p.Available||'TRUE', Category: p.Category || this.fixedCategories[0]}; this.showProductModal=true; },
                async saveProduct() { this.loading=true; await fetch(this.scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'save_product', product: this.editingProduct }) }); this.showProductModal=false; setTimeout(()=>this.fetchData(),2000); },
                async deleteProduct(id) { if(!confirm('ุญุฐูุ')) return; this.loading=true; await fetch(this.scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete_product', id: id }) }); setTimeout(()=>this.fetchData(),2000); },
                
                openModal(o) { this.selectedOrder = o; this.showModal = true; },
                updateStatus(id, s) { fetch(this.scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'update_status', orderId: id, newStatus: s }) }); const idx=this.orders.findIndex(o=>o.Order_ID==id); if(idx>-1) this.orders[idx].Status=s; },
                
                // ุงูุชูุงุฑูุฑ ุงููุงููุฉ
                calculateReports() {
                    const now=new Date(); now.setHours(0,0,0,0); const w=new Date(now); w.setDate(now.getDate()-7); const m=new Date(now); m.setDate(1);
                    this.reportStats = { today:0, week:0, month:0 };
                    this.orders.forEach(o => { const d=new Date(o.Date); d.setHours(0,0,0,0); if(d.getTime()===now.getTime()) this.reportStats.today+=o.Total_Amount; if(d>=w) this.reportStats.week+=o.Total_Amount; if(d>=m) this.reportStats.month+=o.Total_Amount; });
                },
                calculateStats() { this.stats.totalRevenue = this.orders.reduce((s,o)=>s+o.Total_Amount,0); this.stats.totalOrders = this.orders.length; },
                renderChart() { const ctx=document.getElementById('financialChart'); if(!ctx) return; if(this.chartInstance) this.chartInstance.destroy(); const l=[],d=[]; for(let i=6; i>=0; i--) { const dt=new Date(); dt.setDate(dt.getDate()-i); dt.setHours(0,0,0,0); l.push(dt.toLocaleDateString('ar-EG',{weekday:'short'})); d.push(this.orders.filter(o=>{ const od=new Date(o.Date); od.setHours(0,0,0,0); return od.getTime()===dt.getTime(); }).reduce((s,o)=>s+o.Total_Amount,0)); } this.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: l, datasets: [{ label: 'ุงููุจูุนุงุช', data: d, backgroundColor: '#22c55e', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false } }); },

                formatMoney(n) { return Number(n).toLocaleString('en-US') + ' ุฌ'; },
                getStatusColor(s) { const c = {'ุฌุฏูุฏ':'bg-red-100 text-red-800','ุชู ุงูุงุฑุณุงู':'bg-blue-100 text-blue-800','ุชู ุงูุชุณููู':'bg-green-100 text-green-800'}; return c[s] || 'bg-gray-100'; },
                printReceipt(order, note) {
                    const items = this.parseOrderDetails(order.Order_Details).map(i => `<tr><td style="text-align:right">${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:center">${i.price}</td></tr>`).join('');
                    const html = `<div style="text-align:center;border-bottom:1px dashed #333;padding-bottom:10px;margin-bottom:10px"><h2 style="margin:0">ููุชุฌุงุช ูุฏููุชู</h2><p style="font-size:10px">#${order.Order_ID} | ${order.Date.split(',')[0]}</p></div><div style="font-size:11px;text-align:right"><p>ุงูุนููู: ${order.Customer_Name}</p><p>ุช: ${order.Phone}</p></div><table style="width:100%;font-size:11px;border-top:1px dashed #333;margin-top:10px" dir="rtl"><thead><tr><th style="text-align:right">ุตูู</th><th>ุนุฏุฏ</th><th>ุณุนุฑ</th></tr></thead><tbody>${items}</tbody></table>${note?`<p style="font-size:10px;border-top:1px dashed #333;padding-top:5px">ููุงุญุธุฉ: ${note}</p>`:''}<div style="margin-top:10px;font-weight:bold;display:flex;justify-content:space-between"><span>ุงูุฅุฌูุงูู:</span><span>${this.formatMoney(order.Total_Amount)}</span></div><div style="text-align:center;font-size:9px;margin-top:15px">ุดูุฑุงู ูุฒูุงุฑุชูู</div>`;
                    document.getElementById('printable-area').innerHTML = html; window.print();
                },
                parseOrderDetails(s) { if(!s) return []; return s.split('|').map(l => { const m=l.match(/^(.*?)\s*\((\d+)\)(?:\s*-\s*(\d+))?$/); return m ? {name:m[1], qty:m[2], price:m[3]||0} : {name:l, qty:1, price:0}; }); }
            }
        }
    </script>
</body>
</html>
