<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¯ÙŠÙ†ØªÙŠ - n8n Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .nav-item.active { background-color: #dcfce7; color: #15803d; border-right: 4px solid #15803d; }
        .glass { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        [x-cloak] { display: none !important; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .custom-tooltip { visibility: hidden; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; background-color: #1f2937; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.7rem; white-space: nowrap; opacity: 0; transition: opacity 0.3s; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .group:hover .custom-tooltip { visibility: visible; opacity: 1; }
        .status-new { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; animation: soft-pulse 2s infinite; }
        @keyframes soft-pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .status-badge { padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .thermal-receipt { background-color: #ffffff; color: #000000; font-family: 'Courier New', Courier, monospace; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .thermal-line { border-bottom: 1px dashed #000; margin: 8px 0; }
        @media print { body * { visibility: hidden; } #printable-area, #printable-area * { visibility: visible; } #printable-area { position: absolute; left: 0; top: 0; width: 80mm; } }
    </style>
</head>
<body class="text-slate-800" x-data="adminPanel()">
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-white border-l flex-shrink-0 hidden md:flex flex-col z-20 shadow-xl">
            <div class="p-8 border-b text-center bg-green-50">
                <div class="w-12 h-12 bg-green-600 rounded-xl mx-auto flex items-center justify-center text-white text-2xl font-bold mb-2">Ù…</div>
                <h1 class="font-extrabold text-lg text-green-900">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø©<br>Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¯ÙŠÙ†ØªÙŠ</h1>
            </div>
            <nav class="flex-1 p-4 space-y-4 overflow-y-auto mt-4">
                <button @click="currentTab='dashboard'" :class="currentTab==='dashboard'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</button>
                <button @click="currentTab='orders'" :class="currentTab==='orders'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold relative"><span>ğŸ“¦</span> Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span x-show="newOrdersCount > 0" class="absolute left-4 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full" x-text="newOrdersCount"></span></button>
                <button @click="currentTab='products'" :class="currentTab==='products'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ·ï¸</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button @click="currentTab='customers'" :class="currentTab==='customers'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ‘¥</span> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ÙˆÙ„Ø§Ø¡</button>
                <button @click="switchTab('reports')" :class="currentTab==='reports'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ“ˆ</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
            </nav>
            <div class="p-4 border-t text-center bg-gray-50">
                <a href="https://wa.me/201032825648" target="_blank" class="text-xs font-bold text-green-700 flex items-center justify-center gap-2 hover:bg-green-100 p-2 rounded-lg transition decoration-0">
                    <svg class="w-5 h-5 text-[#25D366]" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    <span>ØªØµÙ…ÙŠÙ… Ùˆ Ø¨Ø±Ù…Ø¬Ø© Ù…. Ø¹ÙŠØ¯ Ø§Ù„Ø§ØºØ§</span>
                </a>
            </div>
        </aside>
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-[#f8fafc]">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-4">
                    <button @click="fetchData()" class="bg-white border hover:bg-gray-50 text-gray-700 px-6 py-2 rounded-xl text-sm font-bold shadow-sm flex items-center gap-2 transition"><span x-show="loading" class="animate-spin">â†»</span> ØªØ­Ø¯ÙŠØ«</button>
                    <div class="relative cursor-pointer" @click="currentTab='orders'">
                        <span class="text-2xl text-yellow-500">ğŸ””</span>
                        <span x-show="newOrdersCount > 0" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full animate-pulse" x-text="newOrdersCount"></span>
                    </div>
                </div>
                <div class="text-left"><h2 class="text-2xl font-extrabold text-slate-800" x-text="getPageTitle()"></h2><p class="text-sm font-bold text-green-600 dir-ltr" x-text="currentTimeDate"></p></div>
            </div>
            <div x-show="currentTab==='dashboard'" x-transition>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div @click="toggleCard('best_sellers')" class="bg-white rounded-xl border-2 border-orange-400 p-4 text-center cursor-pointer card-hover relative overflow-hidden group">
                        <div class="custom-tooltip">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹ ÙˆØ·Ù„Ø¨Ø§Ù‹ Ù…Ù† Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</div><p class="text-xs font-bold text-gray-500 mb-1">Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹</p><h3 class="text-xl font-black text-gray-800 flex items-center justify-center gap-1">Top 10 ğŸ”¥</h3><p class="text-[10px] text-gray-400 mt-2">â–¼ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                    </div>
                    <div @click="toggleCard('today_sales')" class="bg-white rounded-xl border-2 border-purple-400 p-4 text-center cursor-pointer card-hover relative group">
                        <div class="custom-tooltip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ù‚ÙŠÙ‚Ù‡Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</div><p class="text-xs font-bold text-gray-500 mb-1">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p><h3 class="text-2xl font-black text-slate-800" x-text="formatMoney(reportStats.today)"></h3><p class="text-[10px] text-gray-400 mt-2">â–¼ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                    </div>
                    <div @click="toggleCard('new_orders')" class="bg-white rounded-xl border-2 border-yellow-400 p-4 text-center cursor-pointer card-hover relative group">
                        <div class="custom-tooltip">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ÙˆØµÙ„Øª Ø­Ø¯ÙŠØ«Ø§Ù‹ ÙˆÙ„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§ Ø¨Ø¹Ø¯</div><p class="text-xs font-bold text-gray-500 mb-1">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p><h3 class="text-3xl font-black text-slate-800" x-text="newOrdersCount"></h3><p class="text-[10px] text-gray-400 mt-2">â–¼ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                    </div>
                    <div class="bg-white rounded-xl border-2 border-blue-400 p-4 text-center cursor-default relative group">
                        <div class="custom-tooltip">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù†Ø° Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div><p class="text-xs font-bold text-gray-500 mb-1">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p><h3 class="text-2xl font-black text-blue-700" x-text="stats.totalOrders"></h3><p class="text-[10px] text-blue-600 mt-2 font-bold">Ø·Ù„Ø¨ Ù…Ø³Ø¬Ù„</p>
                    </div>
                    <div @click="toggleCard('revenue')" class="bg-white rounded-xl border-2 border-green-500 p-4 text-center cursor-pointer card-hover relative group">
                        <div class="custom-tooltip">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ„ÙŠØ©)</div><p class="text-xs font-bold text-gray-500 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</p><h3 class="text-2xl font-black text-slate-800" x-text="formatMoney(stats.totalRevenue)"></h3><p class="text-[10px] text-gray-400 mt-2">â–¼ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                    </div>
                </div>
                <div x-show="expandedCard" x-transition class="glass p-6 border-t-4 border-gray-800 mb-8 animate-fade-in-down">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-lg text-gray-800" x-text="getExpandedTitle()"></h3><button @click="expandedCard=null" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-full hover:bg-red-100">âœ• Ø¥ØºÙ„Ø§Ù‚</button></div>
                    <div class="overflow-x-auto max-h-80 custom-scrollbar"><table class="w-full text-sm text-right"><thead class="bg-gray-100 sticky top-0"><tr><template x-if="expandedCard==='best_sellers'"><th>#</th></template><template x-if="expandedCard==='best_sellers'"><th>Ø§Ù„Ù…Ù†ØªØ¬</th></template><template x-if="expandedCard==='best_sellers'"><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th></template><template x-if="expandedCard!=='best_sellers'"><th>#</th></template><template x-if="expandedCard!=='best_sellers'"><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th></template><template x-if="expandedCard!=='best_sellers'"><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></template><template x-if="expandedCard!=='best_sellers'"><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></template></tr></thead><tbody><template x-for="(item, i) in (expandedCard==='best_sellers'?topSellingProducts.slice(0,10):getExpandedData())" :key="i"><tr class="border-b hover:bg-gray-50"><template x-if="expandedCard==='best_sellers'"><td class="p-2" x-text="i+1"></td></template><template x-if="expandedCard==='best_sellers'"><td class="p-2 font-bold" x-text="item.name"></td></template><template x-if="expandedCard==='best_sellers'"><td class="p-2 text-green-600 font-bold" x-text="item.qty"></td></template><template x-if="expandedCard!=='best_sellers'"><td class="p-2" x-text="item.Order_ID"></td></template><template x-if="expandedCard!=='best_sellers'"><td class="p-2" x-text="item.Customer_Name"></td></template><template x-if="expandedCard!=='best_sellers'"><td class="p-2"><span class="status-badge" :class="getStatusColor(item.Status)" x-text="item.Status"></span></td></template><template x-if="expandedCard!=='best_sellers'"><td class="p-2 font-bold" x-text="formatMoney(item.Total_Amount)"></td></template></tr></template></tbody></table></div>
                </div>
            </div>
            <div x-show="currentTab==='orders'" x-transition>
                <div class="glass p-6 mb-6">
                    <div class="flex flex-col xl:flex-row gap-4 mb-2 items-start xl:items-center">
                        <div class="flex-1 relative w-full"><span class="absolute right-3 top-3 text-gray-400">ğŸ”</span><input x-model="searchQuery" @input="filterList()" type="text" placeholder="Ø¨Ø­Ø«..." class="w-full border border-gray-200 pr-10 pl-4 py-3 rounded-xl text-sm bg-gray-50 focus:bg-white transition"></div>
                        <div class="flex flex-col md:flex-row gap-2 w-full xl:w-auto">
                            <select x-model="statusFilter" @change="filterList()" class="border border-gray-200 p-3 rounded-xl text-sm font-bold text-gray-600 bg-white outline-none w-full md:w-40"><option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option><option value="ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„">ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„</option></select>
                            <select x-model="dateFilter" @change="filterList()" class="border border-gray-200 p-3 rounded-xl text-sm font-bold text-gray-600 bg-white outline-none w-full md:w-40"><option value="all">ğŸ“ ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option><option value="today">ğŸ“… Ø§Ù„ÙŠÙˆÙ…</option><option value="week">ğŸ“… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option><option value="month">ğŸ“… Ø§Ù„Ø´Ù‡Ø±</option><option value="custom">ğŸ› ï¸ Ù…Ø®ØµØµ</option></select>
                        </div>
                    </div>
                    <div x-show="dateFilter === 'custom'" x-transition class="flex flex-col md:flex-row gap-3 mt-3 bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300">
                        <div class="flex items-center gap-2 flex-1"><span class="text-xs font-bold text-gray-500">Ù…Ù†:</span><input type="date" x-model="customStartDate" @change="filterList()" class="border border-gray-300 rounded-lg p-2 text-sm w-full"></div>
                        <div class="flex items-center gap-2 flex-1"><span class="text-xs font-bold text-gray-500">Ø¥Ù„Ù‰:</span><input type="date" x-model="customEndDate" @change="filterList()" class="border border-gray-300 rounded-lg p-2 text-sm w-full"></div>
                    </div>
                    <div class="mt-4 text-left"><span class="text-xs font-bold text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: <span x-text="filteredOrders.length"></span></span></div>
                </div>
                <div class="glass overflow-hidden border border-gray-200">
                    <table class="w-full text-sm text-right">
                        <thead class="bg-gray-50 text-gray-600 font-bold border-b"><tr><th class="p-4">#</th><th class="p-4">Ø§Ù„ÙˆÙ‚Øª</th><th class="p-4">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-4">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="p-4">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th class="p-4">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-4 text-center">Ø­Ø°Ù</th></tr></thead>
                        <tbody class="divide-y divide-gray-100 bg-white">
                            <template x-for="o in filteredOrders" :key="o.Order_ID">
                                <tr class="hover:bg-blue-50 cursor-pointer group" @click="openModal(o)">
                                    <td class="p-4 font-mono text-gray-400" x-text="'#'+o.Order_ID"></td>
                                    <td class="p-4"><div class="font-bold text-slate-700" x-text="timeSince(o.dateObj)"></div><div class="text-[10px] text-gray-400" x-text="o.Date"></div></td>
                                    <td class="p-4 font-bold text-slate-800" x-text="o.Customer_Name"></td>
                                    <td class="p-4"><span class="status-badge shadow-sm" :class="getStatusColor(o.Status)" x-text="o.Status"></span></td>
                                    <td class="p-4 text-xs text-gray-500 max-w-xs truncate" x-text="o.Note || '-'"></td>
                                    <td class="p-4 font-black text-green-700" x-text="formatMoney(o.Total_Amount)"></td>
                                    <td class="p-4 text-center"><button @click.stop="deleteOrder(o.Order_ID)" class="w-8 h-8 rounded-full bg-red-50 text-red-600 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>
                                </tr>
                            </template>
                            <tr x-show="filteredOrders.length === 0"><td colspan="7" class="p-8 text-center text-gray-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div x-show="currentTab==='products'" x-transition>
                <div class="glass p-6">
                    <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-xl text-slate-800">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3><button @click="openProductModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:bg-green-700 transition"> + Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button></div>
                    <div class="flex overflow-x-auto gap-2 mb-6 pb-2"><button @click="productFilter='all'" :class="productFilter==='all'?'bg-slate-800 text-white':'bg-white text-gray-600 border'" class="px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition">Ø§Ù„ÙƒÙ„</button><template x-for="c in fixedCategories"><button @click="productFilter=c" :class="productFilter===c?'bg-slate-800 text-white':'bg-white text-gray-600 border'" class="px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition" x-text="c"></button></template></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4"><template x-for="p in getFilteredProducts()"><div class="bg-white border rounded-xl p-4 hover:shadow-md transition group relative"><div class="flex justify-between mb-2"><span class="text-[10px] bg-gray-100 px-2 py-1 rounded" x-text="p.Category"></span><div class="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button @click="openProductModal(p)" class="text-blue-600 bg-blue-50 p-1 rounded">âœï¸</button><button @click="deleteProduct(p.Name)" class="text-red-600 bg-red-50 p-1 rounded">ğŸ—‘</button></div></div><h4 class="font-bold mb-2" x-text="p.Name"></h4><div class="flex items-end gap-2"><span class="text-green-700 font-bold text-lg" x-text="p.Price + ' Ø¬'"></span><span x-show="p.OldPrice > 0" class="text-gray-400 text-xs line-through mb-1" x-text="p.OldPrice"></span></div></div></template></div>
                </div>
            </div>
            <div x-show="currentTab==='customers'" x-transition>
                <div class="glass p-8">
                    <div class="flex justify-between items-end mb-6 border-b pb-4"><h3 class="font-extrabold text-2xl">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3><button class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold" @click="exportCustomers()">ØªØµØ¯ÙŠØ± Excel ğŸ“¥</button></div>
                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-sm text-right bg-white"><thead class="bg-gray-50 font-bold text-gray-500"><tr><th class="p-3">Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th class="p-3">Ø·Ù„Ø¨Ø§Øª</th><th class="p-3">Ø¥Ù†ÙØ§Ù‚</th><th class="p-3">ÙˆÙ„Ø§Ø¡</th><th class="p-3 text-center">ØªÙˆØ§ØµÙ„</th></tr></thead><tbody class="divide-y"><template x-for="c in processedCustomers"><tr class="hover:bg-gray-50"><td class="p-3 font-bold" x-text="c.name"></td><td class="p-3" x-text="c.count"></td><td class="p-3 text-green-600 font-bold" x-text="formatMoney(c.total)"></td><td class="p-3"><span class="px-2 py-1 rounded text-xs border" :class="getLoyalty(c).class" x-text="getLoyalty(c).label"></span></td><td class="p-3 flex justify-center gap-2"><button @click="openWhatsapp(c.phone)" class="bg-green-50 text-green-600 p-2 rounded-full border border-green-200 hover:bg-green-600 hover:text-white transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg><span>ÙˆØ§ØªØ³Ø§Ø¨</span></button></div>
                    <div class="mt-3 pt-3 border-t text-sm"><p class="font-bold text-gray-500 text-xs mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</p><p x-text="selectedOrder.Address || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ÙˆØ§Ù†'"></p><a x-show="selectedOrder.Location_Link" :href="getMapLink(selectedOrder.Location_Link)" target="_blank" class="mx-auto mt-3 block w-fit bg-blue-600 text-white text-center py-1 px-4 rounded shadow-md hover:bg-blue-700 transition text-xs font-bold">ğŸ“ Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</a></div>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-200">
                     <div class="mb-3"><label class="block text-xs font-bold text-gray-500 mb-2">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</label><div class="flex gap-2"><button @click="updateStatus(selectedOrder.Order_ID, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±')" class="flex-1 py-2 text-xs font-bold rounded border transition shadow-sm" :class="selectedOrder.Status === 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±' ? 'bg-yellow-500 text-white border-yellow-600' : 'bg-white text-yellow-700 border-yellow-200 hover:bg-yellow-50'">ğŸ‘¨â€ğŸ³ ØªØ­Ø¶ÙŠØ±</button><button @click="updateStatus(selectedOrder.Order_ID, 'ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„')" class="flex-1 py-2 text-xs font-bold rounded border transition shadow-sm" :class="selectedOrder.Status === 'ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„' ? 'bg-blue-600 text-white border-blue-700' : 'bg-white text-blue-700 border-blue-200 hover:bg-blue-50'">ğŸš€ Ø¥Ø±Ø³Ø§Ù„</button><button @click="updateStatus(selectedOrder.Order_ID, 'Ù…Ù„ØºÙŠ')" class="flex-1 py-2 text-xs font-bold rounded border transition shadow-sm" :class="selectedOrder.Status === 'Ù…Ù„ØºÙŠ' ? 'bg-red-600 text-white border-red-700' : 'bg-white text-red-700 border-red-200 hover:bg-red-50'">ğŸš« Ù…Ù„ØºÙŠ</button></div></div>
                     <div class="flex gap-2"><input x-model="printNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø©..." class="flex-1 border rounded-lg px-3 text-sm outline-none"><button @click="saveNote()" class="bg-gray-200 px-3 rounded-lg text-sm">Ø­ÙØ¸</button><button @click="printReceipt(selectedOrder, printNote)" class="bg-black text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg flex items-center gap-2">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button></div>
                </div>
            </div>
        </div>
    </div>
        <div x-show="showProductModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
            <h3 class="font-extrabold text-xl mb-6 text-right text-slate-800 border-b pb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬</h3>
            <div class="space-y-4">
                <div><input x-model="editingProduct.Name" type="text" placeholder="Ø§Ù„Ø§Ø³Ù…" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-green-500 transition text-right"></div>
                <div><textarea x-model="editingProduct.Description" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ù…ÙƒÙˆÙ†Ø§ØªØŒ ØªÙØ§ØµÙŠÙ„...)" rows="2" class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:border-green-500 transition text-right resize-none"></textarea></div>
                <div class="flex gap-4"><input x-model="editingProduct.Price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" class="w-1/2 border border-gray-300 rounded-lg p-3 outline-none focus:border-green-500 transition text-right"><input x-model="editingProduct.OldPrice" type="number" placeholder="Ø³Ø¹Ø± Ù‚Ø¯ÙŠÙ…" class="w-1/2 border border-gray-300 rounded-lg p-3 outline-none focus:border-green-500 transition text-right"></div>
                <div><select x-model="editingProduct.Category" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-green-500 text-right text-gray-600"><template x-for="cat in fixedCategories"><option :value="cat" x-text="cat"></option></template></select></div>
                <div><select x-model="editingProduct.Available" class="w-full border border-gray-300 rounded-lg p-3 bg-white outline-none focus:border-green-500 text-right text-gray-600"><option value="TRUE">Ù…ØªØ§Ø­</option><option value="FALSE">ØºÙŠØ± Ù…ØªØ§Ø­</option></select></div>
                <div><input x-model="editingProduct.Cost" type="number" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ© (Ø³Ø±ÙŠ)" class="w-full border border-gray-200 bg-gray-50 rounded-lg p-2 text-xs text-center outline-none"></div>
            </div>
            <div class="mt-6 flex gap-3"><button @click="showProductModal=false" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-lg font-bold hover:bg-gray-200 transition">Ø¥Ù„ØºØ§Ø¡</button><button @click="saveProduct()" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-md">Ø­ÙØ¸</button></div>
        </div>
    </div>
        <div id="printable-area"></div>
    <script>
        function adminPanel() {
            return {
                currentTab: 'dashboard', loading: false, searchQuery: '', 
                statusFilter: 'all', dateFilter: 'all', customStartDate: '', customEndDate: '',
                expandedCard: null, orders: [], filteredOrders: [], products: [], productFilter: 'all', processedCustomers: [],
                fixedCategories: ['Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ±Ø§Ø«ÙŠØ©', 'Ø£ÙƒÙ„Ø§Øª ØªØ±Ø§Ø«ÙŠØ©', 'Ø£Ø¬Ø¨Ø§Ù† ÙˆØ£Ù„Ø¨Ø§Ù†', 'Ù…ÙˆÙ†Ø© ÙˆØ²ÙŠØª', 'Ù„Ø­ÙˆÙ… ÙˆÙ…Ø¹Ù„Ø¨Ø§Øª', 'Ø¨Ù‡Ø§Ø±Ø§Øª ÙˆØªÙˆØ§Ø¨Ù„', 'Ø­Ù„ÙˆÙŠØ§Øª', 'Ù…ÙƒØ³Ø±Ø§Øª', 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©'],
                stats: { totalRevenue: 0, totalOrders: 0 }, reportStats: { today: 0, week: 0, month: 0 },
                financials: { netProfit: 0, margin: 0, aov: 0, newCustomers: 0, topProfitable: [], deadStockList: [] },
                topSellingProducts: [], newOrdersCount: 0, acknowledgedMaxId: 0, showNewOrderAlert: false, notificationData: { name: '', time: '' }, 
                showModal: false, showProductModal: false, selectedOrder: {}, 
                editingProduct: {ID:'', Name:'', Description:'', Price:0, OldPrice:0, Cost:0, Available:'TRUE', Category:'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ±Ø§Ø«ÙŠØ©'},

                printNote: '', currentTimeDate: '', salesChart: null,
                                
                scriptURL: "https://n8n-latest-viqu.onrender.com/webhook/madinaty-api", 
                
                updateView() { 
                    this.filterList();
                    this.processData();
                },

                init() {                     
                    this.fetchData();                     
                    setInterval(() => this.checkForUpdates(), 10000);                     
                    setInterval(() => { this.currentTimeDate = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' }); }, 1000);                
                },

                getPageTitle() { const t = {'dashboard':'Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶','orders':'Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª','products':'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª','customers':'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡','reports':'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©'}; return t[this.currentTab]; },
                switchTab(tab) { this.currentTab = tab; if (tab === 'reports') setTimeout(() => this.renderCharts(), 300); },
                
                handleAlertClick() {                     
                    this.showNewOrderAlert = false; this.currentTab = 'orders'; this.statusFilter = 'Ø¬Ø¯ÙŠØ¯'; this.dateFilter = 'all';                     
                    this.fetchData().then(() => { if (this.orders.length > 0) this.acknowledgedMaxId = Math.max(...this.orders.map(o => o.Order_ID)); });                
                },

                toggleCard(c) { this.expandedCard = this.expandedCard === c ? null : c; },
                getExpandedTitle() { const t={'best_sellers':'Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ø§Ù‹','today_sales':'Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…','new_orders':'Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©','revenue':'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª'}; return t[this.expandedCard] || 'Ø§Ù„ØªÙØ§ØµÙŠÙ„'; },
                getExpandedData() {                     
                    if(this.expandedCard==='new_orders') return this.orders.filter(o=>o.Status==='Ø¬Ø¯ÙŠØ¯');                    
                    if(this.expandedCard==='today_sales') { const t=new Date(); t.setHours(0,0,0,0); return this.orders.filter(o=>{const d=new Date(o.dateObj);d.setHours(0,0,0,0);return d.getTime()===t.getTime()}); }                    
                    return this.orders.slice(0, 50);                 
                },

                async fetchData() {                    
                    this.loading = true;                    
                    try {                        
                        const url = this.scriptURL + '?action=getJSON&t=' + Date.now();
                        const res = await fetch(url);                         
                        if (!res.ok) { throw new Error(`HTTP Error: ${res.status}`); }
                        const data = await res.json();                        
                        
                        this.orders = (data.orders || []).map(o => ({ 
                            ...o, 
                            Total_Amount: parseFloat(String(o.Total_Amount).replace(/[^0-9.]/g, '')) || 0, 
                            dateObj: new Date(o.Date), 
                            Status: (String(o.Status || '').trim() === '' ? 'Ø¬Ø¯ÙŠØ¯' : String(o.Status).trim()), 
                            Order_ID: Number(o.Order_ID) 
                        })).filter(o => o.Order_ID > 0).sort((a, b) => b.dateObj - a.dateObj);                        
                        
                        this.products = (data.products || []).map(p => ({ 
                            ...p, Price: Number(p.Price)||0, 
                            OldPrice: Number(p.OldPrice)||0, 
                            Cost: Number(p.Cost)||0, 
                            Available: p.Available || 'TRUE' 
                        }));                                                
                        
                        if (this.acknowledgedMaxId === 0 && this.orders.length > 0) {                            
                            this.acknowledgedMaxId = Math.max(...this.orders.map(o => o.Order_ID));                        
                        }                        
                        this.processData(); 
                    } catch(e) { console.error("Fetch Data Failed:", e); } finally { this.loading = false; }                
                },

                async checkForUpdates() {                    
                    try {                        
                        const res = await fetch(this.scriptURL + '?action=getJSON&t=' + Date.now());                         
                        const data = await res.json();                        
                        const fetchedOrders = data.orders || [];                        
                        if (fetchedOrders.length > 0) {                            
                            const ids = fetchedOrders.map(o => Number(o.Order_ID));                            
                            const serverMaxId = Math.max(...ids);                                                        
                            if (serverMaxId > this.acknowledgedMaxId && this.acknowledgedMaxId > 0) {                                
                                const newOrder = fetchedOrders.find(o => Number(o.Order_ID) === serverMaxId);                                
                                if(newOrder) {                                    
                                    const timePart = newOrder.Date.includes(',') ? newOrder.Date.split(',')[1] : newOrder.Date;                                    
                                    this.notificationData = { name: newOrder.Customer_Name, time: timePart };                                    
                                    this.showNewOrderAlert = true;                                    
                                    document.getElementById('notifSound').play().catch(e=>{});                                    
                                    this.fetchData();                                 
                                }                            
                            }                        
                        }                        
                        this.newOrdersCount = (fetchedOrders.filter(o => (String(o.Status).trim() || 'Ø¬Ø¯ÙŠØ¯') === 'Ø¬Ø¯ÙŠØ¯')).length; 
                    } catch(e) {}                
                },

                processData() {                    
                    this.filterList(); this.calculateData(); 
                    this.newOrdersCount = this.orders.filter(o => o.Status === 'Ø¬Ø¯ÙŠØ¯').length; 
                    if(this.currentTab === 'reports') this.renderCharts();                
                },
                                
                filterList() {                     
                    let list = (this.orders || []).filter(o => o.Status !== 'Ù…Ø­Ø°ÙˆÙ');                     
                    if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); list = list.filter(o => String(o.Order_ID).includes(q) || (o.Customer_Name||'').toLowerCase().includes(q) || String(o.Phone).includes(q)); }                     
                    
                    if (this.statusFilter !== 'all') { 
                        list = list.filter(o => o.Status === this.statusFilter); 
                    }
                    
                    const now = new Date(); now.setHours(0,0,0,0);                    
                    if (this.dateFilter === 'today') { list = list.filter(o => { const d = new Date(o.dateObj); d.setHours(0,0,0,0); return d.getTime() === now.getTime(); }); }                     
                    else if (this.dateFilter === 'week') { const weekAgo = new Date(now); weekAgo.setDate(now.getDate() - 7); list = list.filter(o => new Date(o.dateObj) >= weekAgo); }                     
                    else if (this.dateFilter === 'month') { const monthAgo = new Date(now); monthAgo.setDate(1); list = list.filter(o => new Date(o.dateObj) >= monthAgo); }                     
                    else if (this.dateFilter === 'custom' && this.customStartDate && this.customEndDate) { const start = new Date(this.customStartDate); const end = new Date(this.customEndDate); end.setHours(23,59,59,999); list = list.filter(o => { const d = new Date(o.dateObj); return d >= start && d <= end; }); }
                    
                    list.sort((a, b) => b.dateObj - a.dateObj);                    
                    this.filteredOrders = list;                 
                },

                calculateData() {                    
                    const custMap = {}; let totalRevenue = 0; let productSales = {}; const now = new Date(); now.setHours(0,0,0,0); this.reportStats = { today:0, week:0, month:0 }; let totalCost = 0;                    
                    this.orders.forEach(o => {                        
                        if(o.Status === 'Ù…Ø­Ø°ÙˆÙ') return;                        
                        totalRevenue += o.Total_Amount; const d = new Date(o.dateObj); d.setHours(0,0,0,0);                        
                        if(d.getTime() === now.getTime()) this.reportStats.today += o.Total_Amount;                        
                        const phone = String(o.Phone).replace(/\D/g, ''); if (!custMap[phone]) custMap[phone] = { name: o.Customer_Name, phone: phone, total: 0, count: 0 }; custMap[phone].total += o.Total_Amount; custMap[phone].count += 1;                        
                        this.parseOrderDetails(o.Order_Details).forEach(item => { const product = this.products.find(p => p.Name.trim() === item.name.trim()); if(product) { totalCost += (product.Cost * item.qty); productSales[product.Name] = (productSales[product.Name] || 0) + item.qty; } });                    
                    });                    
                    this.stats.totalRevenue = totalRevenue; 
                    this.stats.totalOrders = this.orders.length; 
                    this.processedCustomers = Object.values(custMap).sort((a,b) => b.total - a.total);                    
                    
                    let safeTotalRevenue = totalRevenue > 0 ? totalRevenue : 1; 
                    this.financials.netProfit = totalRevenue - totalCost; 
                    this.financials.margin = Math.round((this.financials.netProfit / safeTotalRevenue) * 100);
                    if (totalRevenue === 0) this.financials.margin = 0; 
                    this.financials.aov = this.stats.totalOrders > 0 ? Math.round(totalRevenue / this.stats.totalOrders) : 0;
                    this.financials.newCustomers = this.processedCustomers.filter(c => c.count === 1).length;                    
                    this.financials.topProfitable = this.products.map(p => ({ name: p.Name, profit: (p.Price - p.Cost) * (productSales[p.Name]||0) })).sort((a,b) => b.profit - a.profit).slice(0, 5);                    
                    this.financials.deadStockList = this.products.filter(p => !productSales[p.Name]);                    
                    this.topSellingProducts = Object.entries(productSales).map(([name, qty]) => ({ name, qty })).sort((a, b) => b.qty - a.qty);                
                },

                renderCharts() {                    
                    const ctx1 = document.getElementById('salesChart'); if(!ctx1) return; if(this.salesChart) this.salesChart.destroy();                    
                    const labels = []; const data = []; for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0); labels.push(d.toLocaleDateString('ar-EG',{weekday:'short'})); const val = this.orders.filter(o=>{ const od = new Date(o.dateObj); od.setHours(0,0,0,0); return od.getTime()===d.getTime() && o.Status !== 'Ù…Ø­Ø°ÙˆÙ'; }).reduce((s,o)=>s+o.Total_Amount,0); data.push(val); }                    
                    this.salesChart = new Chart(ctx1, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª', data: data, backgroundColor: '#10b981', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false } });                
                },

                timeSince(date) { const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " Ø³Ø§Ø¹Ø©"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " Ø¯Ù‚ÙŠÙ‚Ø©"; return "Ø§Ù„Ø¢Ù†"; },
                openWhatsapp(phone) { if (!phone) return; let p = String(phone).replace(/\D/g, ''); if (p.startsWith('0')) p = p.substring(1); window.open(`https://wa.me/2${p}`, '_blank'); },
                getMapLink(link) { if (link && link.includes('googleusercontent')) { const m = link.match(/query=([\d\.]+),([\d\.]+)/); if (m) return `http://googleusercontent.com/maps.google.com/?api=1&query=${m[1]},${m[2]}`; } return link || '#'; },
                                
                async postToN8n(body) {                    
                    await fetch(this.scriptURL, {                         
                        method: 'POST',                         
                        headers: { 'Content-Type': 'application/json' },                        
                        body: JSON.stringify(body)                     
                    });                
                },

                saveNote() {                     
                    if(!this.selectedOrder.Order_ID) return;                     
                    this.selectedOrder.Note = this.printNote;                     
                    this.postToN8n({ action: 'save_note', orderId: this.selectedOrder.Order_ID, note: this.printNote });                    
                    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); this.updateView();                 
                },
                                
                parseOrderDetails(s) { if (!s) return []; return s.split('|').map(l => { const m = l.match(/^(.*?)\s*\((\d+)\)\s*-\s*(\d+)/); if (m) return { name: m[1].trim(), qty: Number(m[2]), price: Number(m[3]) }; const old = l.match(/^(.*?)\s*\((\d+)\)/); return old ? { name: old[1].trim(), qty: Number(old[2]), price: 0 } : { name: l.trim(), qty: 1, price: 0 }; }); },
                formatMoney(n) { return Number(n).toLocaleString('en-US') + ' Ø¬'; },
                getStatusColor(s) { return {'Ø¬Ø¯ÙŠØ¯':'status-new','ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„':'bg-blue-100 text-blue-800','ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…':'bg-green-100 text-green-800','Ù…Ù„ØºÙŠ':'bg-red-100 text-red-800'}[s] || 'bg-gray-100'; },
                openModal(o) { this.selectedOrder = o; this.printNote = o.Note || ''; this.showModal = true; this.showNewOrderAlert = false; },
                                
                updateStatus(id, s) {                     
                    this.postToN8n({ action: 'update_status', orderId: id, newStatus: s });                    
                    this.selectedOrder.Status = s; const idx = this.orders.findIndex(o => o.Order_ID == id); if(idx > -1) this.orders[idx].Status = s; this.updateView();                 
                },
                                
                async deleteOrder(id) {                    
                    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;                    
                    const idx = this.orders.findIndex(o => o.Order_ID === id);                    
                    if(idx > -1) this.orders[idx].Status = 'Ù…Ø­Ø°ÙˆÙ';                                        
                    this.processData();                    
                    this.postToN8n({ action: 'delete_order', id: id });                
                },
                                
                getCustomerStats(phone) { if (!phone) return { total: 0 }; const p = String(phone).replace(/\D/g, ''); const customer = this.processedCustomers.find(c => c.phone === p); return customer || { total: 0 }; },
                getLoyalty(c) { if(c.total>5000) return {label:'VIP', class:'bg-yellow-100 text-yellow-800 border-yellow-200'}; if(c.total>2000) return {label:'Ù…Ù…ÙŠØ²', class:'bg-blue-100 text-blue-800 border-blue-200'}; return {label:'Ø¹Ø§Ø¯ÙŠ', class:'bg-gray-100 text-gray-600'}; },
                getFilteredProducts() { if (this.productFilter === 'all') return this.products; return this.products.filter(p => p.Category === this.productFilter); },
                
                openProductModal(p={}) { 
                    this.editingProduct={
                        ID: p.ID || '', 
                        Name: p.Name || '',
                        Description: p.Description || '',
                        Price: Number(p.Price) || 0,
                        OldPrice: Number(p.OldPrice) || 0,
                        Cost: Number(p.Cost) || 0,
                        Available: p.Available || 'TRUE',
                        Category: p.Category || this.fixedCategories[0]
                    }; 
                    this.showProductModal=true; 
                },
                                
                async saveProduct() { 
                    // Ù…Ù†Ø·Ù‚ ØªÙˆÙ„ÙŠØ¯ ID ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹
                    let finalID = this.editingProduct.ID;
                    if (!finalID) {
                         const existingIds = this.products.map(p => Number(p.ID)).filter(n => !isNaN(n));
                         // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© Ø§Ø¨Ø¯Ø£ Ø¨Ù€ 1ØŒ ÙˆØ¥Ù„Ø§ Ø®Ø° Ø§Ù„Ø£ÙƒØ¨Ø± ÙˆØ£Ø¶Ù 1
                         finalID = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                    }

                    const productToSend = {
                        ID: finalID,
                        Name: this.editingProduct.Name || '',
                        Description: this.editingProduct.Description || '',
                        Category: this.editingProduct.Category || '',
                        Available: this.editingProduct.Available || 'FALSE',
                        Price: Number(this.editingProduct.Price) || 0,
                        OldPrice: Number(this.editingProduct.OldPrice) || 0,
                        Cost: Number(this.editingProduct.Cost) || 0 
                    };

                    await this.postToN8n({ action: 'save_product', product: productToSend });

                    this.showProductModal=false; 
                    setTimeout(()=>this.fetchData(),1500); 
                },
                                
                async deleteProduct(productName) { 
                    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ' + productName + 'ØŸ')) return; 
                    this.postToN8n({ action: 'delete_product', productName: productName });
                    setTimeout(()=>this.fetchData(), 1500); 
                },
                                
                exportCustomers() { let csv = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø·Ù„Ø¨Ø§Øª,Ø§Ù„Ø¥Ù†ÙØ§Ù‚\n" + this.processedCustomers.map(c => `${c.name},'${c.phone},${c.count},${c.total}`).join("\n"); const link = document.createElement("a"); link.href = "data:text/csv;charset=utf-8,%EF%BB%BF" + encodeURI(csv); link.download = "customers.csv"; link.click(); },
                printReceipt(order, note) { 
                    const items = this.parseOrderDetails(order.Order_Details).map(i => `<tr><td style="text-align:right;">${i.name}</td><td>${i.qty}</td><td>${i.price}</td></tr>`).join('');
                    const html = `<div style="font-family:'Courier New';direction:rtl;text-align:center;width:80mm"><h3>Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¯ÙŠÙ†ØªÙŠ</h3><p>#${order.Order_ID}</p><hr><div style="text-align:right"><p>Ø§Ù„Ø¹Ù…ÙŠÙ„: ${order.Customer_Name}</p><p>Øª: ${order.Phone}</p></div><hr><table style="width:100%;text-align:center"><thead><tr><th style="text-align:right">ØµÙ†Ù</th><th>Ø¹</th><th>Ø³</th></tr></thead><tbody>${items}</tbody></table><hr><h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${this.formatMoney(order.Total_Amount)}</h3>${note?`<p>Ù…Ù„Ø§Ø­Ø¸Ø©: ${note}</p>`:''}</div>`;
                    document.getElementById('printable-area').innerHTML = html; window.print();
                }
            }
        }
    </script>
</body>
</html>
