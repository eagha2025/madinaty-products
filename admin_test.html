<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¯ÙŠÙ†ØªÙŠ - n8n Powered</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .nav-item.active { background-color: #dcfce7; color: #15803d; border-right: 4px solid #15803d; }
        .glass { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03 ); border: 1px solid #f1f5f9; }
        [x-cloak] { display: none !important; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .custom-tooltip { visibility: hidden; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 8px; background-color: #1f2937; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 0.7rem; white-space: nowrap; opacity: 0; transition: opacity 0.3s; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent; }
        .group:hover .custom-tooltip { visibility: visible; opacity: 1; }
        .status-new { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; animation: soft-pulse 2s infinite; }
        @keyframes soft-pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .status-badge { padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
        .thermal-receipt { background-color: #ffffff; color: #000000; font-family: 'Courier New', Courier, monospace; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .thermal-line { border-bottom: 1px dashed #000; margin: 8px 0; }
        @media print { body * { visibility: hidden; } #printable-area, #printable-area * { visibility: visible; } #printable-area { position: absolute; left: 0; top: 0; width: 80mm; } }
    </style>
</head>
<body class="text-slate-800" x-data="adminPanel()">
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    
    <!-- Modal for New Order Alert -->
    <div x-show="showNewOrderAlert" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center p-4" @click.self="showNewOrderAlert = false">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl text-center">
            <span class="text-5xl mb-4 block">ğŸ‰</span>
            <h3 class="font-extrabold text-xl mb-2 text-slate-800">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯!</h3>
            <p class="text-gray-600 mb-6">ÙˆØµÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† <strong x-text="notificationData.name"></strong> ÙÙŠ <span x-text="notificationData.time"></span>.</p>
            <button @click="handleAlertClick( )" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition shadow-md">Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <aside class="w-64 bg-white border-l flex-shrink-0 hidden md:flex flex-col z-20 shadow-xl">
            <div class="p-8 border-b text-center bg-green-50">
                <div class="w-12 h-12 bg-green-600 rounded-xl mx-auto flex items-center justify-center text-white text-2xl font-bold mb-2">Ù…</div>
                <h1 class="font-extrabold text-lg text-green-900">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø©  
Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¯ÙŠÙ†ØªÙŠ</h1>
            </div>
            <nav class="flex-1 p-4 space-y-4 overflow-y-auto mt-4">
                <button @click="currentTab='dashboard'" :class="currentTab==='dashboard'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ“Š</span> Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶</button>
                <button @click="currentTab='orders'" :class="currentTab==='orders'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold relative"><span>ğŸ“¦</span> Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span x-show="newOrdersCount > 0" class="absolute left-4 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full" x-text="newOrdersCount"></span></button>
                <button @click="currentTab='products'" :class="currentTab==='products'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ·ï¸</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button @click="currentTab='customers'" :class="currentTab==='customers'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ‘¥</span> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„ÙˆÙ„Ø§Ø¡</button>
                <button @click="switchTab('reports')" :class="currentTab==='reports'?'active':''" class="nav-item w-full flex items-center gap-4 px-4 py-3 text-gray-500 rounded-r-xl hover:bg-gray-50 transition font-bold"><span>ğŸ“ˆ</span> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
            </nav>
            <div class="p-4 border-t text-center bg-gray-50">
                <a href="https://wa.me/201032825648" target="_blank" class="text-xs font-bold text-green-700 flex items-center justify-center gap-2 hover:bg-green-100 p-2 rounded-lg transition decoration-0">
                    <svg class="w-5 h-5 text-[#25D366]" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    <span>ØªØµÙ…ÙŠÙ… Ùˆ Ø¨Ø±Ù…Ø¬Ø© Ù…. Ø¹ÙŠØ¯ Ø§Ù„Ø§ØºØ§</span>
                </a>
            </div>
        </aside>
        <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-[#f8fafc]">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-4">
                    <button @click="fetchData( )" class="bg-white border hover:bg-gray-50 text-gray-700 px-6 py-2 rounded-xl text-sm font-bold shadow-sm flex items-center gap-2 transition"><span x-show="loading" class="animate-spin">â†»</span> ØªØ­Ø¯ÙŠØ«</button>
                    <div class="relative cursor-pointer" @click="currentTab='orders'">
                        <span class="text-2xl text-yellow-500">ğŸ””</span>
                        <span x-show="newOrdersCount > 0" class="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full animate-pulse" x-text="newOrdersCount"></span>
                    </div>
                </div>
                <div class="text-left"><h2 class="text-2xl font-extrabold text-slate-800" x-text="getPageTitle()"></h2><p class="text-sm font-bold text-green-600 dir-ltr" x-text="currentTimeDate"></p></div>
            </div>
            
            <!-- All Tabs Content -->
            <div x-show="currentTab==='dashboard'" x-transition>
                <!-- Dashboard content here -->
            </div>
            <div x-show="currentTab==='orders'" x-transition>
                <!-- Orders content here -->
            </div>
            <div x-show="currentTab==='products'" x-transition>
                <!-- Products content here -->
            </div>
            <div x-show="currentTab==='customers'" x-transition>
                <!-- Customers content here -->
            </div>
            <div x-show="currentTab==='reports'" x-transition>
                <!-- Reports content here -->
            </div>

        </main>
    </div>

    <!-- Modals for Order Details and Product Edit -->
    <div x-show="showModal" x-cloak class="fixed inset-0 z-40 bg-black bg-opacity-50" @click="showModal=false"></div>
    <div x-show="showModal" x-cloak class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 bg-white rounded-2xl w-full max-w-md shadow-2xl flex flex-col" style="max-height: 90vh;">
        <!-- Order Details Modal Content -->
    </div>

    <div x-show="showProductModal" x-cloak class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
            <!-- Product Modal Content -->
        </div>
    </div>

    <div id="printable-area" class="hidden"></div>

    <script>
        function adminPanel() {
            return {
                // State
                currentTab: 'dashboard',
                loading: false,
                orders: [],
                products: [],
                processedCustomers: [],
                stats: { totalRevenue: 0, totalOrders: 0 },
                reportStats: { today: 0 },
                newOrdersCount: 0,
                acknowledgedMaxId: 0,
                
                // UI State
                showModal: false,
                showProductModal: false,
                showNewOrderAlert: false,
                notificationData: { name: '', time: '' },
                selectedOrder: {},
                editingProduct: {},
                printNote: '',
                currentTimeDate: '',

                // Filters
                searchQuery: '',
                statusFilter: 'all',
                dateFilter: 'all', // Default to 'all'
                customStartDate: '',
                customEndDate: '',
                productFilter: 'all',
                
                // Config
                scriptURL: "https://n8n-latest-viqu.onrender.com/webhook/madinaty-api",
                fixedCategories: ['Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ±Ø§Ø«ÙŠØ©', 'Ø£ÙƒÙ„Ø§Øª ØªØ±Ø§Ø«ÙŠØ©', 'Ø£Ø¬Ø¨Ø§Ù† ÙˆØ£Ù„Ø¨Ø§Ù†', 'Ù…ÙˆÙ†Ø© ÙˆØ²ÙŠØª', 'Ù„Ø­ÙˆÙ… ÙˆÙ…Ø¹Ù„Ø¨Ø§Øª', 'Ø¨Ù‡Ø§Ø±Ø§Øª ÙˆØªÙˆØ§Ø¨Ù„', 'Ø­Ù„ÙˆÙŠØ§Øª', 'Ù…ÙƒØ³Ø±Ø§Øª', 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©'],

                // Computed Properties
                get filteredOrders( ) {
                    let list = this.orders.filter(o => o.Status !== 'Ù…Ø­Ø°ÙˆÙ');
                    if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); list = list.filter(o => String(o.Order_ID).includes(q) || (o.Customer_Name||'').toLowerCase().includes(q) || String(o.Phone).includes(q)); }
                    if (this.statusFilter !== 'all') { list = list.filter(o => o.Status === this.statusFilter); }
                    const now = new Date(); now.setHours(0,0,0,0);
                    if (this.dateFilter === 'today') { list = list.filter(o => { const d = new Date(o.dateObj); d.setHours(0,0,0,0); return d.getTime() === now.getTime(); }); }
                    else if (this.dateFilter === 'week') { const weekAgo = new Date(now); weekAgo.setDate(now.getDate() - 7); list = list.filter(o => new Date(o.dateObj) >= weekAgo); }
                    else if (this.dateFilter === 'month') { const monthAgo = new Date(now); monthAgo.setDate(1); list = list.filter(o => new Date(o.dateObj) >= monthAgo); }
                    else if (this.dateFilter === 'custom' && this.customStartDate && this.customEndDate) { const start = new Date(this.customStartDate); const end = new Date(this.customEndDate); end.setHours(23,59,59,999); list = list.filter(o => { const d = new Date(o.dateObj); return d >= start && d <= end; }); }
                    return list.sort((a, b) => b.dateObj - a.dateObj);
                },
                getFilteredProducts() {
                    if (this.productFilter === 'all') return this.products;
                    return this.products.filter(p => p.Category === this.productFilter);
                },

                // Methods
                init() {
                    this.fetchData();
                    setInterval(() => this.checkForUpdates(), 10000);
                    setInterval(() => { this.currentTimeDate = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:'2-digit' }); }, 1000);
                },

                async fetchData() {
                    this.loading = true;
                    try {
                        const res = await fetch(this.scriptURL + '?action=getJSON&t=' + Date.now());
                        if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                        const data = await res.json();
                        
                        this.orders = (data.orders || []).map(o => ({
                            ...o,
                            Total_Amount: parseFloat(String(o.Total_Amount).replace(/[^0-9.]/g, '')) || 0,
                            dateObj: new Date(o.Date),
                            Status: (String(o.Status || '').trim() === '' ? 'Ø¬Ø¯ÙŠØ¯' : String(o.Status).trim()),
                            Order_ID: Number(o.Order_ID)
                        })).filter(o => o.Order_ID > 0);

                        this.products = (data.products || []).map(p => ({ ...p, Price: Number(p.Price)||0, OldPrice: Number(p.OldPrice)||0, Cost: Number(p.Cost)||0, Available: p.Available || 'TRUE' }));
                        
                        if (this.acknowledgedMaxId === 0 && this.orders.length > 0) {
                            this.acknowledgedMaxId = Math.max(...this.orders.map(o => o.Order_ID));
                        }
                        this.processData();
                    } catch (e) {
                        console.error("Fetch Data Failed:", e);
                    } finally {
                        this.loading = false;
                    }
                },

                async checkForUpdates() {
                    try {
                        const res = await fetch(this.scriptURL + '?action=getJSON&t=' + Date.now());
                        const data = await res.json();
                        const fetchedOrders = data.orders || [];
                        if (fetchedOrders.length > 0) {
                            const serverMaxId = Math.max(...fetchedOrders.map(o => Number(o.Order_ID)));
                            if (serverMaxId > this.acknowledgedMaxId) {
                                const newOrder = fetchedOrders.find(o => Number(o.Order_ID) === serverMaxId);
                                if (newOrder) {
                                    const timePart = newOrder.Date.includes(',') ? newOrder.Date.split(',')[1].trim() : newOrder.Date;
                                    this.notificationData = { name: newOrder.Customer_Name, time: timePart };
                                    this.showNewOrderAlert = true;
                                    document.getElementById('notifSound').play().catch(e => {});
                                    await this.fetchData(); // Await fetching new data
                                    this.acknowledgedMaxId = serverMaxId; // Acknowledge after fetch
                                }
                            }
                        }
                    } catch (e) { console.error("Check for updates failed:", e); }
                },

                processData() {
                    this.newOrdersCount = this.orders.filter(o => o.Status === 'Ø¬Ø¯ÙŠØ¯').length;
                    // ... other calculations
                },

                async postToN8n(body) {
                    try {
                        await fetch(this.scriptURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        });
                    } catch (e) {
                        console.error("Post to n8n failed:", e);
                        alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    }
                },

                async updateStatus(id, newStatus) {
                    const order = this.orders.find(o => o.Order_ID === id);
                    if (order) {
                        order.Status = newStatus;
                        if (this.selectedOrder.Order_ID === id) {
                            this.selectedOrder.Status = newStatus;
                        }
                        this.processData(); // Recalculate newOrdersCount
                        await this.postToN8n({ action: 'update_status', orderId: id, newStatus: newStatus });
                    }
                },

                async saveProduct() {
                    if (!this.editingProduct.Name) {
                        alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨.');
                        return;
                    }
                    this.showProductModal = false;
                    await this.postToN8n({ action: 'save_product', product: this.editingProduct });
                    await this.fetchData(); // Refresh data from server
                },

                async deleteProduct(productName) {
                    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬: ' + productName + 'ØŸ')) return;
                    await this.postToN8n({ action: 'delete_product', productName: productName });
                    await this.fetchData(); // Refresh data from server
                },

                handleAlertClick() {
                    this.showNewOrderAlert = false;
                    this.currentTab = 'orders';
                    this.statusFilter = 'Ø¬Ø¯ÙŠØ¯';
                    this.dateFilter = 'all';
                },
                
                // Other helper functions (openModal, getPageTitle, etc.)
                openModal(o) { this.selectedOrder = { ...o }; this.printNote = o.Note || ''; this.showModal = true; },
                openProductModal(p = {}) {
                    this.editingProduct = {
                        ID: p.ID || '', Name: p.Name || '', Description: p.Description || '',
                        Price: Number(p.Price) || 0, OldPrice: Number(p.OldPrice) || 0, Cost: Number(p.Cost) || 0,
                        Available: p.Available || 'TRUE', Category: p.Category || this.fixedCategories[0]
                    };
                    this.showProductModal = true;
                },
                getPageTitle() { const t = {'dashboard':'Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±Ø¶','orders':'Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª','products':'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª','customers':'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡','reports':'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©'}; return t[this.currentTab]; },
                // ... include all other helper functions from your original file
            }
        }
    </script>
</body>
</html>
